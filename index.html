<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ButcherCode</title>
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-o6p4D+E2n9B0o2k2yX2b/f/2q+6a+8+z3f6q3g+4y+5t6u7p8s9w=" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
    /* Definindo variáveis CSS para cores */
    :root {
      --cor-fundo-principal: #113311;
      --cor-fundo-secundario: #002200;
      --cor-texto-principal: #b3ffb3;
      --cor-texto-secundario: #aaffaa;
      --cor-header-fundo: #005500;
      --cor-sidebar-fundo: #004400;
      --cor-borda-clara: #b3ffb3;
      --cor-input-fundo: #001100;
      --cor-input-borda: #88aa88;
      --cor-input-placeholder: #88aa88;
      --cor-botao-fundo: #006600;
      --cor-botao-hover: #008800;
      --cor-botao-texto: #ccffcc;
      --cor-link: #88ff88;
      --cor-destaque: #00cc00;
      --cor-erro: #ff6666;
      --cor-aviso: #ffaa00;
      --cor-critico: #ff0000;
      --cor-sucesso: #00ff00;
      --cor-modal-fundo: #002200;
      --cor-modal-sombra: rgba(0, 255, 0, 0.2);
      --cor-camuflagem: brightness(0.4) blur(3px);
    }

    body {
      margin: 0;
      background: var(--cor-fundo-principal);
      color: var(--cor-texto-principal);
      font-family: 'Source Code Pro', monospace;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      transition: margin-left 0.3s ease, background 0.3s ease, color 0.3s ease;
      padding-bottom: 20px;
    }
    body.sidebar-open main {
      margin-left: 320px;
      filter: var(--cor-camuflagem);
      opacity: 0.6;
      pointer-events: none;
      transition: filter 0.3s ease, opacity 0.3s ease, margin-left 0.3s ease;
    }

    body:not(.sidebar-open) main {
        filter: brightness(1) blur(0);
        opacity: 1;
        pointer-events: auto;
        transition: filter 0.3s ease, opacity 0.3s ease, margin-left 0.3s ease;
    }

    header {
      background: var(--cor-header-fundo);
      padding: 15px 30px;
      display: flex;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1001; /* Garante que o header esteja acima de tudo, exceto o modal */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease;
      justify-content: space-between;
    }
    #hamburger {
      cursor: pointer;
      width: 35px;
      height: 26px;
      position: relative;
    }
    #hamburger span {
      background: var(--cor-borda-clara);
      position: absolute;
      height: 3px;
      width: 100%;
      left: 0;
      border-radius: 2px;
      transition: 0.3s ease, background 0.3s ease;
    }
    #hamburger span:nth-child(1) {
      top: 0;
    }
    #hamburger span:nth-child(2) {
      top: 11px;
    }
    #hamburger span:nth-child(3) {
      top: 22px;
    }
    #hamburger.open span:nth-child(1) {
      transform: rotate(45deg);
      top: 11px;
    }
    #hamburger.open span:nth-child(2) {
      opacity: 0;
    }
    #hamburger.open span:nth-child(3) {
      transform: rotate(-45deg);
      top: 11px;
    }

    h1 {
      margin: 0;
      font-size: 2.2rem;
      font-weight: bold;
      animation: fadeInScale 1s ease forwards;
      flex-grow: 1;
      text-align: center;
      cursor: pointer;
      user-select: none;
      margin-right: 35px;
    }
    @keyframes fadeInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    #sidebar {
      position: fixed;
      top: 65px;
      left: 0;
      width: 300px;
      height: calc(100vh - 65px);
      background: var(--cor-sidebar-fundo);
      color: var(--cor-texto-principal);
      overflow-y: auto;
      z-index: 1000; /* Sidebar deve estar abaixo do header mas acima do conteúdo */
      padding: 20px;
      transform: translateX(-100%);
      transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }
    #sidebar.open {
      transform: translateX(0);
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 1.4rem;
      border-bottom: 1px solid var(--cor-borda-clara);
      padding-bottom: 8px;
      margin-bottom: 15px;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 25px;
      transition: border-color 0.3s ease, color 0.3s ease;
    }
    #sidebar h2::after {
      content: "▶";
      position: absolute;
      right: 5px;
      top: 2px;
      transition: transform 0.3s ease;
      color: var(--cor-texto-principal);
    }
    #sidebar h2.open::after {
      transform: rotate(90deg);
    }

    /* Ajustes para listas semânticas */
    .menu-sections {
        list-style: none; /* Remove estilo padrão de lista */
        padding: 0;
        margin: 0;
    }

    .menu-section {
      margin-bottom: 25px;
    }
    .subfolder {
      margin-left: 20px;
      display: none;
      margin-bottom: 12px;
      list-style: none; /* Remove estilo padrão de lista para subfolders que são UL */
      padding: 0; /* Remove padding padrão para subfolders que são UL */
    }
    .subfolder.open {
      display: block;
    }
    /* Estilos para os itens da lista da sidebar (agora li) */
    .subfolder .item {
      cursor: pointer;
      padding: 5px 8px;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .subfolder .item:hover {
      background: var(--cor-botao-fundo);
      transition: background 0.3s ease;
    }

    main {
      margin: 100px 30px 30px 30px;
      max-width: 700px;
      transition: margin-left 0.3s ease, background-color 0.3s ease;
      padding: 20px;
      background-color: var(--cor-fundo-secundario);
      border-radius: 8px;
    }
    /* Hide all main sections by default */
    #mainTerminalSection, #gameCodeSection, #initialScreen, #addProductSection, #commentsSection, #userProfileSection {
        display: none;
    }
    /* Show only the active section */
    main.show-terminal #mainTerminalSection {
        display: block;
    }
    main.show-game #gameCodeSection {
        display: block;
    }
    main.show-initial #initialScreen {
        display: block;
    }
    main.show-add-product #addProductSection {
        display: block;
    }
    main.show-comments #commentsSection {
        display: block;
    }
    main.show-profile #userProfileSection {
        display: block;
    }


    /* Styles for sidebar list items */
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--cor-botao-texto);
      transition: color 0.3s ease;
    }
    .input-wrapper {
      position: relative;
      display: flex;
      flex-direction: column; /* Alterado para empilhar label e input */
      margin-bottom: 15px;
    }
    input, button {
      padding: 12px;
      font-size: 1.2rem;
      border-radius: 6px;
    }
    input::placeholder {
      color: var(--cor-input-placeholder);
    }
    input:focus {
      outline: none;
      border-color: var(--cor-destaque);
      box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
    }
    input {
      flex-grow: 1;
      width: 100%;
      background: var(--cor-input-fundo);
      border: 1px solid var(--cor-input-borda);
      color: var(--cor-texto-principal);
      font-family: 'Source Code Pro', monospace;
      padding-right: 12px;
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }
    /* Estilos para o select */
    select {
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
        border-radius: 6px;
        background: var(--cor-input-fundo);
        border: 1px solid var(--cor-input-borda);
        color: var(--cor-texto-principal);
        font-family: 'Source Code Pro', monospace;
        margin-top: 5px;
        appearance: none; /* Remove seta padrão em alguns navegadores */
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23b3ffb3%22%20d%3D%22M287%2069.9a17.6%2017.6%200%200%200-24.8%200L146.2%20185.7%2030.2%2069.9a17.6%2017.6%200%200%200-24.8%2024.8l139%20139.1a17.6%2017.6%200%200%200%2024.8%200l139-139.1a17.6%2017.6%200%200%200%200-24.8z%22%2F%3E%3C%2Fsvg%3E'); /* Seta customizada */
        background-repeat: no-repeat;
        background-position: right 10px top 50%;
        background-size: 12px auto;
    }
    select:focus {
        outline: none;
        border-color: var(--cor-destaque);
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
    }

    button {
      margin-top: 0px;
      background: var(--cor-botao-fundo);
      color: var(--cor-botao-texto);
      border: none;
      font-family: 'Source Code Pro', monospace;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
      width: 100%;
    }
    button:hover {
      background: var(--cor-botao-hover);
    }
    #result {
      margin-top: 25px;
      min-height: 40px;
      font-size: 1.6rem;
      font-weight: bold;
      border: 2px solid var(--cor-destaque);
      padding: 12px;
      border-radius: 8px;
      background: var(--cor-fundo-secundario);
      white-space: nowrap;
      overflow: hidden;
      position: relative;
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    #result .marquee {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 10s linear infinite;
      animation-play-state: paused;
      transform: translateX(100%);
    }
    #result.scrolling .marquee {
      animation-play-state: running;
    }
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    #instructionsContent {
      background: var(--cor-fundo-secundario);
      padding: 15px;
      border-radius: 6px;
      font-size: 1rem;
      line-height: 1.7;
      color: var(--cor-texto-secundario);
      transition: background 0.3s ease, color 0.3s ease;
    }
    #instructionsContent p {
      margin-bottom: 10px;
    }
    #instructionsContent p:last-child {
      margin-bottom: 0;
    }

    /* Estilos para o ícone de feedback no resultado */
    #result .feedback-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.8em;
        opacity: 0;
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    #result.success .feedback-icon.show {
        opacity: 1;
        color: var(--cor-sucesso);
        transform: translateY(-50%) scale(1.1);
    }
    #result.error .feedback-icon.show {
        opacity: 1;
        color: var(--cor-erro);
        transform: translateY(-50%) scale(1.1);
    }


    /* --- Estilos para o Modal de Senha (Login/Registro Firebase) --- */
    #authModalOverlay { /* Renomeado de passwordModalOverlay */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none; /* ALTERADO: Começa oculto */
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #authModalOverlay.show {
        opacity: 1;
        visibility: visible;
        display: flex; /* Mostra o modal quando a classe show é adicionada */
    }

    #authModal { /* Renomeado de passwordModal */
      background: var(--cor-modal-fundo);
      padding: 40px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px var(--cor-modal-sombra);
      max-width: 400px;
      width: 90%;
      color: var(--cor-texto-principal);
      transform: translateY(-20px);
      transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    #authModalOverlay.show #authModal {
        transform: translateY(0);
    }

    #authModal h2 {
      margin-top: 0;
      font-size: 1.8rem;
      color: var(--cor-botao-texto);
      margin-bottom: 20px;
    }

    #passwordInput, #usernameInput { /* Removido emailInput */
      width: calc(100% - 24px);
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--cor-destaque);
      background: var(--cor-input-fundo);
      color: var(--cor-texto-principal);
      border-radius: 6px;
      font-size: 1.1rem;
      text-align: center;
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    #passwordInput:focus, #usernameInput:focus { /* Removido emailInput */
      outline: none;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
    }

    #authSubmit, #registerButton { /* Renomeado de passwordSubmit */
      padding: 12px 30px;
      background: var(--cor-botao-fundo);
      color: var(--cor-botao-texto);
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
      margin-bottom: 10px; /* Espaçamento entre os botões */
    }

    #authSubmit:hover, #registerButton:hover {
      background: var(--cor-botao-hover);
    }

    #authError { /* Renomeado de passwordError */
      color: var(--cor-erro);
      margin-top: 10px;
      font-size: 0.95rem;
      min-height: 20px;
    }

    #welcomeMessage {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--cor-texto-secundario);
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      margin-bottom: 20px;
    }
    #welcomeMessage.show {
        opacity: 1;
        pointer-events: auto;
    }

    #initial-screen-options {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 30px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease, visibility 0.5s ease;
        padding: 0 20px;
        box-sizing: border-box;
    }
    #initial-screen-options.show {
        opacity: 1;
        visibility: visible;
    }
    #initial-screen-options button {
        background-color: var(--cor-botao-hover);
        color: var(--cor-botao-texto);
        padding: 15px;
        font-size: 1.3rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    #initial-screen-options button:hover {
        background-color: var(--cor-destaque);
        transform: translateY(-2px);
    }


    /* --- Estilos para Resultado (Sucesso/Erro) --- */
    #result.success {
      border-color: var(--cor-destaque);
      background-color: var(--cor-fundo-secundario);
      color: var(--cor-sucesso);
    }

    #result.error {
      border-color: var(--cor-critico);
      background-color: #330000;
      color: var(--cor-erro);
    }

    /* --- Estilos para o Jogo --- */
    #game-container {
      padding: 15px;
      background-color: var(--cor-fundo-secundario);
      border-radius: 6px;
      color: var(--cor-texto-secundario);
      text-align: center;
      transition: background 0.3s ease, color 0.3s ease;
    }

    #question {
      font-size: 1.1rem;
      margin-bottom: 15px;
      min-height: 3em;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #options button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--cor-botao-fundo);
      color: var(--cor-botao-texto);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Source Code Pro', monospace;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #options button:hover:not(:disabled) {
      background-color: var(--cor-botao-hover);
    }
    #options button:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    #feedback {
      margin-top: 10px;
      font-weight: bold;
      min-height: 2em;
    }

    #feedback.correct {
      color: var(--cor-sucesso);
    }

    #feedback.incorrect {
      color: var(--cor-erro);
    }

    #score-display {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.05rem;
      min-height: 1.5em;
    }

    #next-question {
      padding: 10px 20px;
      background-color: var(--cor-botao-fundo);
      color: var(--cor-botao-texto);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Source Code Pro', monospace;
      margin-top: 15px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #next-question:hover {
      background-color: var(--cor-botao-hover);
    }

    #end-game-button {
      padding: 10px 20px;
      background-color: var(--cor-critico);
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Source Code Pro', monospace;
      margin-top: 15px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #end-game-button:hover {
      background-color: #aa0000;
    }


    #game-start-screen, #game-end-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      background-color: var(--cor-fundo-secundario);
      border-radius: 8px;
      min-height: 200px;
      transition: background 0.3s ease, color 0.3s ease;
    }
    #game-start-screen h3, #game-end-screen h3 {
      font-size: 1.8rem;
      color: var(--cor-botao-texto);
      margin-bottom: 20px;
    }
    #game-end-screen p {
      font-size: 1.2rem;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    #start-game-button, #restart-game-button {
      padding: 15px 30px;
      background-color: var(--cor-botao-hover);
      color: var(--cor-botao-texto);
      border: none;
      border-radius: 8px;
      font-size: 1.4rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease, color 0.3s ease;
    }
    #start-game-button:hover, #restart-game-button:hover {
      background-color: var(--cor-destaque);
      transform: translateY(-2px);
    }

    #progress-bar-container {
      width: 100%;
      background-color: var(--cor-input-fundo);
      border-radius: 5px;
      margin-top: 15px;
      overflow: hidden;
      height: 10px;
      position: relative;
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: var(--cor-sucesso);
      border-radius: 5px;
      transition: width 0.1s linear, background-color 0.3s ease;
    }
    #timer {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 10px;
      color: var(--cor-texto-secundario);
      transition: color 0.3s ease;
    }
    #timer.warning {
        color: var(--cor-aviso);
    }
    #timer.critical {
        color: var(--cor-critico);
    }
    #question-counter {
        font-size: 0.9em;
        color: var(--cor-texto-secundario);
        transition: color 0.3s ease;
    }

    /* Estilo para o novo botão "Voltar ao Início" */
    .back-to-home-button {
        display: block;
        margin-top: 30px;
        width: 100%;
        padding: 12px;
        background-color: #555500;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease, color 0.3s ease;
    }

    .back-to-home-button:hover {
        background-color: #777700;
        transform: translateY(-2px);
    }

    /* Estilos para a seção de adicionar produto */
    #addProductSection {
        padding: 20px;
        background-color: var(--cor-fundo-secundario);
        border-radius: 8px;
        margin-top: 30px;
        color: var(--cor-texto-secundario);
    }
    #addProductSection h2 {
        color: var(--cor-botao-texto);
        font-size: 1.6rem;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--cor-destaque);
        padding-bottom: 10px;
    }
    #addProductSection label {
        margin-bottom: 5px;
        color: var(--cor-texto-principal);
    }
    #addProductSection input[type="number"] {
        -moz-appearance: textfield;
    }
    #addProductSection input::-webkit-outer-spin-button,
    #addProductSection input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    #addProductSection input, #addProductSection select {
        margin-bottom: 15px;
    }

    /* Estilos para a seção de comentários */
    #commentsSection {
        padding: 20px;
        background-color: var(--cor-fundo-secundario);
        border-radius: 8px;
        margin-top: 30px;
        color: var(--cor-texto-secundario);
    }
    #commentsSection h2 {
        color: var(--cor-botao-texto);
        font-size: 1.6rem;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--cor-destaque);
        padding-bottom: 10px;
    }
    #commentsSection textarea {
        width: calc(100% - 24px);
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid var(--cor-input-borda);
        background: var(--cor-input-fundo);
        color: var(--cor-texto-principal);
        border-radius: 6px;
        font-family: 'Source Code Pro', monospace;
        font-size: 1.1rem;
        min-height: 100px;
        resize: vertical;
        transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }
    #commentsSection textarea:focus {
        outline: none;
        border-color: var(--cor-destaque);
        box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
    }
    #commentsSection button {
        margin-top: 0;
        margin-bottom: 15px;
    }
    #commentsList {
        margin-top: 20px;
        border-top: 1px dashed var(--cor-borda-clara);
        padding-top: 15px;
    }
    .comment-item {
        background-color: #003300;
        border: 1px solid var(--cor-borda-clara);
        border-radius: 6px;
        padding: 10px 15px;
        margin-bottom: 10px;
        word-wrap: break-word;
        transition: background-color 0.3s ease;
    }
    .comment-item strong {
        color: var(--cor-destaque);
    }
    .comment-item span.timestamp {
        font-size: 0.8em;
        color: var(--cor-texto-secundario);
        display: block;
        margin-top: 5px;
    }
    #commentsFeedback {
        color: var(--cor-sucesso);
        margin-top: 10px;
        font-weight: bold;
    }

    /* Estilos para a seção de perfil do usuário */
    #userProfileSection {
        padding: 20px;
        background-color: var(--cor-fundo-secundario);
        border-radius: 8px;
        margin-top: 30px;
        color: var(--cor-texto-secundario);
    }
    #userProfileSection h2 {
        color: var(--cor-botao-texto);
        font-size: 1.6rem;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--cor-destaque);
        padding-bottom: 10px;
    }
    #userProfileSection p {
        font-size: 1.1rem;
        margin-bottom: 10px;
    }
    #userProfileSection button {
        margin-top: 15px;
    }
    #usernameDisplay {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--cor-destaque);
        margin-bottom: 15px;
    }

  </style>
</head>
<body>
  <div id="authModalOverlay">
    <div id="authModal">
      <h2 id="authModalTitle">Bem-vindo, Mestre Açougueiro!</h2>
      <p id="authPrompt">Faça login ou crie uma conta para prosseguir:</p>
      <input type="text" id="usernameInput" placeholder="Seu Nome de Usuário" autocomplete="off" />
      <input type="password" id="passwordInput" placeholder="Sua Senha" autocomplete="current-password" />
      <div id="authError"></div>
      <button id="authSubmit">Entrar</button>
      <button id="registerButton" style="background-color: #008800;">Criar Conta</button>
      </div>
  </div>

  <header>
    <div id="hamburger" aria-label="Menu" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <h1 id="butcherCodeTitle" role="button" tabindex="0">ButcherCode</h1>
    <div style="width: 35px;"></div>
  </header>

  <nav id="sidebar" aria-label="Menu lateral">
    <ul class="menu-sections">
      <li class="menu-section">
        <h2 tabindex="0" data-target="bovinosList" data-type="accordion">Códigos Bovinos</h2>
        <ul class="subfolder" id="bovinosList"></ul>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="suinosList" data-type="accordion">Códigos Suínos</h2>
        <ul class="subfolder" id="suinosList"></ul>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="instructionsContent" data-type="accordion">Instruções</h2>
        <div class="subfolder" id="instructionsContent">
          <p>Digite um código ou o nome do produto no campo "Terminal ButcherCode" e clique em "Executar".</p>
          <p>Se digitar o código, aparecerá o nome do produto correspondente.</p>
          <p>Se digitar o nome do produto, aparecerá o código.</p>
          <p>Use o menu lateral para consultar os códigos e aprender.</p>
        </div>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="mainTerminalSection" data-type="main-content">Terminal de Consulta</h2>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="gameCodeSection" data-type="main-content">GameCode</h2>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="addProductSection" data-type="main-content">Adicionar Produto</h2>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="commentsSection" data-type="main-content">Comentários e Feedback</h2>
      </li>
       <li class="menu-section">
        <h2 tabindex="0" data-target="userProfileSection" data-type="main-content">Meu Perfil</h2>
      </li>
      <li class="menu-section" id="logoutSection" style="display:none;">
        <h2 tabindex="0" id="logoutButton" style="color: var(--cor-erro); border-color: var(--cor-erro); cursor:pointer;">Sair (Logout)</h2>
      </li>
    </ul>
  </nav>

  <main class="show-initial">
    <section id="initialScreen" style="text-align: center; padding-top: 50px;">
        <div id="welcomeMessage"></div>
        <div id="initial-screen-options">
            <button id="accessTerminalButton">Acessar Terminal</button>
            <button id="playGameCodeButton">Jogar GameCode</button>
            <button id="viewCommentsButton">Ver Comentários</button>
        </div>
    </section>

    <section id="mainTerminalSection">
        <label for="inputCode">Terminal ButcherCode</label>
        <div class="input-wrapper">
            <input type="text" id="inputCode" placeholder="Digite código ou produto aqui..." autocomplete="off" />
        </div>
        <button id="btnExecute">Executar</button>
        <div id="result" aria-live="polite" role="status"></div>
        <button class="back-to-home-button" id="backToHomeTerminal">Voltar ao Início</button>
    </section>

    <section id="addProductSection">
        <h2>Adicionar Novo Produto</h2>
        <div class="input-wrapper">
            <label for="inputNewCode">Código (máximo 5 dígitos):</label>
            <input type="number" id="inputNewCode" placeholder="Ex: 00123" min="0" max="99999" />
        </div>
        <div class="input-wrapper">
            <label for="inputNewName">Nome do Produto:</label>
            <input type="text" id="inputNewName" placeholder="Ex: Filé Mignon" />
        </div>
        <div class="input-wrapper">
            <label for="selectNewCategory">Categoria:</label>
            <select id="selectNewCategory">
                <option value="bovinos">Bovinos</option>
                <option value="suinos">Suínos</option>
            </select>
        </div>
        <button id="btnAddNewProduct">Adicionar Produto</button>
        <div id="addProductFeedback" style="margin-top: 15px; font-weight: bold; min-height: 20px;"></div>
        <button class="back-to-home-button" id="backToHomeAddProduct">Voltar ao Início</button>
    </section>

    <section id="commentsSection">
        <h2>Seus Comentários e Feedback</h2>
        <div class="input-wrapper">
            <label for="commentInput">Escreva seu comentário:</label>
            <textarea id="commentInput" placeholder="Digite seu feedback, dicas ou sugestões aqui..."></textarea>
        </div>
        <button id="submitCommentButton">Enviar Comentário</button>
        <div id="commentsFeedback"></div>
        <div id="commentsList">
            <p style="text-align: center; color: var(--cor-texto-secundario);">Carregando comentários...</p>
        </div>
        <button class="back-to-home-button" id="backToHomeComments">Voltar ao Início</button>
    </section>

    <section id="userProfileSection">
        <h2>Meu Perfil</h2>
        <p>Olá, <span id="usernameDisplay"></span>!</p>
        <p>Identificador de conta (não é um email real): <span id="userEmailDisplay"></span></p> 
        <button id="editUsernameButton">Alterar Nome de Usuário</button>
        <input type="text" id="newUsernameInput" placeholder="Novo nome de usuário" style="display:none; margin-top: 10px;" />
        <button id="saveUsernameButton" style="display:none;">Salvar Nome de Usuário</button>
        <div id="usernameUpdateFeedback" style="color: var(--cor-sucesso); margin-top: 10px; font-weight: bold;"></div>
        <button class="back-to-home-button" id="backToHomeProfile">Voltar ao Início</button>
    </section>

    <section id="gameCodeSection">
        <div id="game-container">
            <div id="game-start-screen">
              <h3>Bem-vindo ao GameCode!</h3>
              <p>Teste seus conhecimentos sobre os códigos de açougue.</p>
              <p>Você terá 15 segundos para responder a cada uma das 20 perguntas.</p>
              <button id="start-game-button">Iniciar Jogo</button>
            </div>

            <div id="game-elements" style="display: none;">
              <div id="question-counter"></div>
              <div id="progress-bar-container">
                <div id="progress-bar"></div>
              </div>
              <div id="timer"></div>
              <div id="question"></div>
              <div id="options">
                </div>
              <div id="feedback"></div>
              <div id="score-display"></div>
              <button id="next-question">Próxima Pergunta</button>
              <button id="end-game-button">Finalizar Jogo</button>
            </div>

            <div id="game-end-screen" style="display: none;">
              <h3>Jogo Finalizado!</h3>
              <p id="final-score-message"></p>
              <button id="restart-game-button">Reiniciar Jogo</button>
            </div>
        </div>
        <button class="back-to-home-button" id="backToHomeGame">Voltar ao Início</button>
    </section>
  </main>

<script type="module">
  // --- IMPORTANTE: ATENÇÃO À SEGURANÇA! ---
  // As chaves de API e IDs de Pantry/Firebase estão diretamente no código do frontend.
  // Isso é um risco de segurança em aplicações de produção, pois qualquer pessoa pode vê-las.
  // Para produção, você deve:
  // 1. Para Firebase: Usar Variáveis de Ambiente no processo de build/deploy OU
  //    configurar REGRAS DE SEGURANÇA MUITO RÍGIDAS no Firebase Firestore e Authentication.
  //    (Exemplos de regras de segurança para Firestore são dados nas instruções abaixo).
  // 2. Para Pantry: O Pantry.cloud não possui regras de segurança como o Firebase.
  //    Se usuários puderem ADICIONAR/MODIFICAR dados, o ideal é mover os dados de produto
  //    para o Firebase Firestore e usar um backend (Node.js, Python, etc.) para as operações de escrita,
  //    ou configurar o Pantry como "read-only" e gerenciar as escritas de forma manual/offline.

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, updateDoc, setDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  // Sua configuração do Firebase (MANTENHA SEUS VALORES AQUI)
  const firebaseConfig = {
    apiKey: "AIzaSyCenbkggBbZmkc8ULS--1iL0KIsm4Flmpk",
    authDomain: "butchercode-4e998.firebaseapp.com",
    projectId: "butchercode-4e998",
    storageBucket: "butchercode-4e998.firebasestorage.app",
    messagingSenderId: "535961032533",
    appId: "1:535961032533:web:de1ad79b53c18f125d01dc"
  };

  // Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- O código JavaScript principal agora está dentro de DOMContentLoaded ---
  document.addEventListener('DOMContentLoaded', () => {

    // --- Referências aos Elementos DOM ---
    const authModalOverlay = document.getElementById('authModalOverlay');
    const authModal = document.getElementById('authModal');
    const authModalTitle = document.getElementById('authModalTitle');
    const authPrompt = document.getElementById('authPrompt');
    // const emailInput = document.getElementById('emailInput'); // Removido
    const passwordInput = document.getElementById('passwordInput');
    const usernameInput = document.getElementById('usernameInput');
    const authSubmit = document.getElementById('authSubmit');
    const registerButton = document.getElementById('registerButton');
    const authError = document.getElementById('authError');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const initialScreenOptions = document.getElementById('initial-screen-options');
    const butcherCodeTitle = document.getElementById('butcherCodeTitle');
    const logoutSection = document.getElementById('logoutSection');
    const logoutButton = document.getElementById('logoutButton');

    // Elementos de perfil
    const userProfileSection = document.getElementById('userProfileSection');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const userEmailDisplay = document.getElementById('userEmailDisplay'); // Este exibirá o e-mail falso
    const editUsernameButton = document.getElementById('editUsernameButton');
    const newUsernameInput = document.getElementById('newUsernameInput');
    const saveUsernameButton = document.getElementById('saveUsernameButton');
    const usernameUpdateFeedback = document.getElementById('usernameUpdateFeedback');

    const mainTerminalSection = document.getElementById('mainTerminalSection');
    const inputCode = document.getElementById('inputCode');
    const btnExecute = document.getElementById('btnExecute');
    const resultDiv = document.getElementById('result');
    const bovinosList = document.getElementById('bovinosList');
    const suinosList = document.getElementById('suinosList');

    // Elementos para adicionar produto
    const addProductSection = document.getElementById('addProductSection');
    const inputNewCode = document.getElementById('inputNewCode');
    const inputNewName = document.getElementById('inputNewName');
    const selectNewCategory = document.getElementById('selectNewCategory');
    const btnAddNewProduct = document.getElementById('btnAddNewProduct');
    const addProductFeedback = document.getElementById('addProductFeedback');
    const backToHomeAddProductButton = document.getElementById('backToHomeAddProduct');

    // Elementos da seção de comentários
    const commentsSection = document.getElementById('commentsSection');
    const commentInput = document.getElementById('commentInput');
    const submitCommentButton = document.getElementById('submitCommentButton');
    const commentsFeedback = document.getElementById('commentsFeedback');
    const commentsList = document.getElementById('commentsList');
    const backToHomeCommentsButton = document.getElementById('backToHomeComments');

    // Elementos da barra lateral e navegação
    const mainContent = document.querySelector('main');
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const sidebarTitles = document.querySelectorAll('#sidebar h2');
    const initialScreen = document.getElementById('initialScreen');

    const backToHomeTerminalButton = document.getElementById('backToHomeTerminal');
    const backToHomeGameButton = document.getElementById('backToHomeGame');
    const backToHomeProfileButton = document.getElementById('backToHomeProfile');
    const accessTerminalButton = document.getElementById('accessTerminalButton');
    const playGameCodeButton = document.getElementById('playGameCodeButton');
    const viewCommentsButton = document.getElementById('viewCommentsButton');

    // Elementos do GameCode
    const gameCodeSection = document.getElementById('gameCodeSection');
    const gameStartScreen = document.getElementById('game-start-screen');
    const gameEndScreen = document.getElementById('game-end-screen');
    const gameElements = document.getElementById('game-elements');
    const startGameButton = document.getElementById('start-game-button');
    const restartGameButton = document.getElementById('restart-game-button');
    const questionElement = document.getElementById('question');
    const optionsElement = document.getElementById('options');
    const feedbackElement = document.getElementById('feedback');
    const scoreDisplayElement = document.getElementById('score-display');
    const nextQuestionButton = document.getElementById('next-question');
    const progressBar = document.getElementById('progress-bar');
    const timerElement = document.getElementById('timer');
    const questionCounterElement = document.getElementById('question-counter');
    const finalScoreMessage = document.getElementById('final-score-message');
    const endGameButton = document.getElementById('end-game-button');


    let currentUser = null; // Variável para armazenar o usuário logado
    let activeAccordionItem = null;

    // --- Integração com Pantry.cloud (para produtos) ---
    const PANTRY_ID = '4f7072cc-f2b3-4852-a675-8fa440048289'; // <--- SEU PANTRY ID
    const BASKET_NAME = 'butcher_products'; // Nome da cesta que você criou no Pantry

    let productData = { bovinos: {}, suinos: {}, meta: { version: 1, last_updated: "" } }; // Variável global para armazenar os dados carregados
    let productsInverseNormalized = {}; // Também será preenchido dinamicamente

    // --- Constantes do Jogo ---
    const GAME_STATE_KEY = "game_code_state";
    const TIME_PER_QUESTION = 15;
    let timeLeft;
    let timerInterval;
    let tickSoundInterval;

    let currentQuestionIndex = 0;
    let score = 0;
    let questions = [];

    // --- Funções de Som ---
    const sounds = {
        correct: new Audio('images/sounds/correct.mp3'),
        incorrect: new Audio('images/sounds/incorrect.mp3'),
        gameStart: new Audio('images/sounds/game-start.mp3'),
        gameEnd: new Audio('images/sounds/game-end.mp3'),
        tick: new Audio('images/sounds/tick.mp3'),
        terminalSuccess: new Audio('images/sounds/terminal-success.mp3'),
        terminalError: new Audio('images/sounds/terminal-error.mp3')
    };

    function playSound(soundName) {
        if (sounds[soundName]) {
            sounds[soundName].currentTime = 0; // Reinicia o som se já estiver tocando
            sounds[soundName].play().catch(e => console.warn("Erro ao tocar som:", soundName, e)); // Usa warn para não parar a execução
        }
    }

    // --- Funções Auxiliares ---
    function normalizeText(text) {
        return text
            .normalize("NFD") // Normaliza caracteres unicode
            .replace(/[\u0300-\u036f]/g, "") // Remove acentos
            .toLowerCase()
            .replace(/\s+/g, '') // Remove espaços em branco
            .trim();
    }

    // Função para gerar um e-mail "falso" a partir do nome de usuário
    function generateFakeEmail(username) {
        // Usa um domínio fixo. Certifique-se de que este domínio não existe de verdade.
        // Ou, se existir, que você tenha controle sobre ele para evitar conflitos.
        return `${normalizeText(username).replace(/[^a-z0-9]/g, '')}@butchercode.com`;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // --- Lógica de Exibição de Seções ---
    function showSection(sectionId) {
        // Remove todas as classes 'show-...' do main
        mainContent.classList.remove('show-terminal', 'show-game', 'show-initial', 'show-add-product', 'show-comments', 'show-profile');

        // Esconde todos os botões de voltar ao início
        document.querySelectorAll('.back-to-home-button').forEach(btn => btn.style.display = 'none');

        // Limpa e para o timer do jogo se mudar de seção
        clearInterval(timerInterval);
        clearInterval(tickSoundInterval);
        timeLeft = TIME_PER_QUESTION; // Reseta o tempo
        if (progressBar) progressBar.style.width = '100%'; // Garante que a barra esteja cheia

        // Exibe a seção correta e o botão "Voltar ao Início" correspondente
        if (sectionId === 'mainTerminalSection') {
            mainContent.classList.add('show-terminal');
            backToHomeTerminalButton.style.display = 'block';
            inputCode.focus(); // Foca no input do terminal
        } else if (sectionId === 'gameCodeSection') {
            mainContent.classList.add('show-game');
            gameStartScreen.style.display = 'flex'; // Garante que a tela de início do jogo seja exibida
            gameElements.style.display = 'none';
            gameEndScreen.style.display = 'none';
            startGameButton.focus();
            backToHomeGameButton.style.display = 'block';
        } else if (sectionId === 'addProductSection') {
            mainContent.classList.add('show-add-product');
            backToHomeAddProductButton.style.display = 'block';
            inputNewCode.focus();
        } else if (sectionId === 'commentsSection') {
            if (!currentUser) { // Redireciona para o login se não estiver logado
                showAuthModal('Você precisa fazer login para ver e enviar comentários.');
                return;
            }
            mainContent.classList.add('show-comments');
            loadComments(); // Carrega os comentários ao exibir a seção
            backToHomeCommentsButton.style.display = 'block';
            commentInput.focus();
        } else if (sectionId === 'userProfileSection') {
            if (!currentUser) { // Redireciona para o login se não estiver logado
                showAuthModal('Você precisa fazer login para ver seu perfil.');
                return;
            }
            mainContent.classList.add('show-profile');
            // Atualiza o display do username no perfil caso tenha sido alterado
            getDoc(doc(db, 'users', currentUser.uid)).then(docSnap => {
                const userData = docSnap.data();
                usernameDisplay.textContent = userData && userData.username ? userData.username : 'Carregando...'; // Exibe o username real
                userEmailDisplay.textContent = currentUser.email; // Exibe o email falso
            }).catch(e => console.error("Erro ao carregar dados do perfil:", e));
            backToHomeProfileButton.style.display = 'block';
        } else if (sectionId === 'initialScreen') {
            mainContent.classList.add('show-initial');
            welcomeMessage.classList.add('show');
            initialScreenOptions.classList.add('show');
        }

        // Fecha a sidebar e remove o filtro do corpo
        hamburger.classList.remove('open');
        sidebar.classList.remove('open');
        document.body.classList.remove('sidebar-open');
    }

    // --- Funções de Autenticação Firebase (modificadas para username) ---
    function showAuthModal(message = '') {
        authError.textContent = message;
        authModalOverlay.classList.add('show');
        usernameInput.focus(); // Foca no input do username
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Usuário logado
            currentUser = user;
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                const userData = userDocSnap.exists() ? userDocSnap.data() : null;
                const displayName = userData && userData.username ? userData.username : 'Usuário'; // Usa o username do Firestore
                
                welcomeMessage.innerHTML = `Bem-vindo, ${displayName}! <br>Vamos desenrolar!`;
                welcomeMessage.classList.add('show');

                initialScreenOptions.classList.add('show');
                authModalOverlay.classList.remove('show');
                logoutSection.style.display = 'block';
                
                // Atualiza informações do perfil
                usernameDisplay.textContent = displayName;
                userEmailDisplay.textContent = user.email; // Ainda exibe o email "falso" do Firebase Auth

                // Carrega comentários se o usuário estiver logado
                loadComments();

            } catch (error) {
                console.error("Erro ao carregar dados do usuário no Firestore:", error);
                // Mesmo com erro no Firestore, o usuário está autenticado
                welcomeMessage.innerHTML = `Bem-vindo, ${user.email.split('@')[0]}! <br>Vamos desenrolar!`; // Fallback para o email se o username não for carregado
                welcomeMessage.classList.add('show');
                initialScreenOptions.classList.add('show');
                authModalOverlay.classList.remove('show');
                logoutSection.style.display = 'block';
                usernameDisplay.textContent = user.email.split('@')[0];
                userEmailDisplay.textContent = user.email;
                loadComments();
            }

        } else {
            // Usuário deslogado
            currentUser = null;
            welcomeMessage.classList.remove('show');
            initialScreenOptions.classList.remove('show');
            showAuthModal(''); // Exibe o modal para login/registro
            authModalTitle.textContent = 'Bem-vindo, Mestre Açougueiro!';
            authPrompt.textContent = 'Faça login ou crie uma conta para prosseguir:';
            usernameInput.value = '';
            passwordInput.value = '';
            authSubmit.textContent = 'Entrar';
            registerButton.style.display = 'block';
            logoutSection.style.display = 'none';
            usernameInput.focus();
            showSection('initialScreen'); // Volta para a tela inicial
            usernameDisplay.textContent = '';
            userEmailDisplay.textContent = '';
        }
    });

    authSubmit.addEventListener('click', async () => {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        authError.textContent = '';

        if (authSubmit.textContent === 'Voltar para Login') {
            authPrompt.textContent = 'Faça login ou crie uma conta para prosseguir:';
            authModalTitle.textContent = 'Bem-vindo, Mestre Açougueiro!';
            authSubmit.textContent = 'Entrar';
            registerButton.textContent = 'Criar Conta';
            authError.textContent = '';
            usernameInput.focus();
            return;
        }

        if (!username || !password) {
            authError.textContent = 'Por favor, insira nome de usuário e senha.';
            return;
        }

        try {
            // Buscar o email falso associado ao username no Firestore
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where('username', '==', username));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                authError.textContent = 'Nome de usuário ou senha inválidos.';
                return;
            }

            // Assumimos que o username é único, pegamos o primeiro resultado
            const userData = querySnapshot.docs[0].data();
            const fakeEmail = userData.email; // O email armazenado no Firestore, que é o falso

            if (!fakeEmail) { // Caso o email falso não esteja no Firestore (erro na criação original)
                authError.textContent = 'Erro na conta. Por favor, contate o suporte.';
                console.error('Usuário encontrado no Firestore sem email falso:', userData);
                return;
            }

            await signInWithEmailAndPassword(auth, fakeEmail, password);
            // onAuthStateChanged cuidará da interface
        } catch (error) {
            console.error("Erro ao fazer login:", error);
            let errorMessage = "Erro no login.";
            if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                errorMessage = "Nome de usuário ou senha inválidos.";
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = "Muitas tentativas de login. Tente novamente mais tarde.";
            } else {
                errorMessage = `Erro: ${error.message}`;
            }
            authError.textContent = errorMessage;
        }
    });

    registerButton.addEventListener('click', async () => {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        authError.textContent = '';

        if (registerButton.textContent === 'Criar Conta') {
            authPrompt.textContent = 'Preencha seus dados para criar sua conta:';
            authModalTitle.textContent = 'Criar Nova Conta';
            authSubmit.textContent = 'Voltar para Login';
            registerButton.textContent = 'Registrar';
            usernameInput.focus();
        } else {
            if (!username) {
                authError.textContent = 'Por favor, insira um nome de usuário.';
                return;
            }
            if (!password) {
                authError.textContent = 'Por favor, insira uma senha.';
                return;
            }

            // Verificar se o nome de usuário já existe no Firestore
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where('username', '==', username));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                authError.textContent = 'Este nome de usuário já está em uso.';
                return;
            }

            try {
                const fakeEmail = generateFakeEmail(username); // Gera o email falso
                
                const userCredential = await createUserWithEmailAndPassword(auth, fakeEmail, password);
                const user = userCredential.user;
                
                // Salva o nome de usuário REAL e o email FALSO no Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    username: username,
                    email: fakeEmail, // Armazenar o email falso para referência futura
                    createdAt: serverTimestamp()
                });
                // onAuthStateChanged cuidará da interface
            } catch (error) {
                console.error("Erro ao registrar:", error);
                let errorMessage = "Erro no registro.";
                if (error.code === 'auth/email-already-in-use') { // Isso pode acontecer se o email falso gerado já existir (improvável, mas possível)
                    errorMessage = "Um erro inesperado ocorreu. Tente outro nome de usuário.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                } else {
                    errorMessage = `Erro: ${error.message}`;
                }
                authError.textContent = errorMessage;
            }
        }
    });

    logoutButton.addEventListener('click', async () => {
        try {
            await signOut(auth);
            alert("Você foi desconectado.");
            // onAuthStateChanged cuidará da interface
        } catch (error) {
            console.error("Erro ao fazer logout:", error);
            alert("Erro ao fazer logout.");
        }
    });

    editUsernameButton.addEventListener('click', () => {
        newUsernameInput.style.display = 'block';
        saveUsernameButton.style.display = 'block';
        usernameUpdateFeedback.textContent = ''; // Limpa feedback anterior

        if (currentUser) {
            getDoc(doc(db, 'users', currentUser.uid)).then(docSnap => {
                const userData = docSnap.data();
                newUsernameInput.value = userData && userData.username ? userData.username : 'Carregando...';
                newUsernameInput.focus();
            }).catch(e => console.error("Erro ao carregar nome de usuário para edição:", e));
        }
        editUsernameButton.style.display = 'none';
    });

    saveUsernameButton.addEventListener('click', async () => {
        const newUsername = newUsernameInput.value.trim();
        if (!newUsername) {
            usernameUpdateFeedback.textContent = 'O nome de usuário não pode estar vazio.';
            usernameUpdateFeedback.style.color = 'var(--cor-erro)';
            return;
        }

        if (currentUser) {
            try {
                // Primeiro, verificar se o novo nome de usuário já existe para outro UID
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', newUsername));
                const querySnapshot = await getDocs(q);

                let usernameExists = false;
                querySnapshot.forEach(doc => {
                    if (doc.id !== currentUser.uid) { // Verifica se não é o próprio usuário
                        usernameExists = true;
                    }
                });

                if (usernameExists) {
                    usernameUpdateFeedback.textContent = 'Este nome de usuário já está em uso por outro usuário.';
                    usernameUpdateFeedback.style.color = 'var(--cor-erro)';
                    return;
                }

                const userDocRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userDocRef, {
                    username: newUsername
                });
                usernameDisplay.textContent = newUsername;
                usernameUpdateFeedback.textContent = 'Nome de usuário atualizado com sucesso!';
                usernameUpdateFeedback.style.color = 'var(--cor-sucesso)';
                newUsernameInput.style.display = 'none';
                saveUsernameButton.style.display = 'none';
                editUsernameButton.style.display = 'block';
                welcomeMessage.innerHTML = `Bem-vindo, ${newUsername}! <br>Vamos desenrolar!`; // Atualiza a mensagem de boas-vindas
                setTimeout(() => usernameUpdateFeedback.textContent = '', 3000);
            } catch (error) {
                console.error("Erro ao atualizar nome de usuário:", error);
                usernameUpdateFeedback.textContent = `Erro ao atualizar: ${error.message}`;
                usernameUpdateFeedback.style.color = 'var(--cor-erro)';
            }
        }
    });


    // --- Lógica de Carregamento e Persistência de Produtos (Pantry.cloud) ---
    async function loadProductData() {
        try {
            const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`);
            if (!response.ok) {
                // Se o Pantry estiver vazio ou o basket não existir, ele retorna 404
                if (response.status === 404) {
                    console.warn("Pantry basket não encontrado ou vazio. Usando dados padrão.");
                    productData = { bovinos: {}, suinos: {}, meta: { version: 1, last_updated: new Date().toISOString() } };
                    // Tenta salvar os dados padrão para criar o basket no Pantry
                    await saveProductData();
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } else {
                const data = await response.json();
                productData = data;
            }
            
            // Reconstrói o índice inverso e preenche a sidebar
            rebuildProductIndexesAndSidebar();
            
            console.log("Dados carregados com sucesso do Pantry:", productData);
        } catch (error) {
            console.error("Erro ao carregar dados do Pantry:", error);
            // Fallback para dados locais se o carregamento falhar ou houver problema com o Pantry
            productData = {
                "meta": { "version": 1, "last_updated": new Date().toISOString() },
                "bovinos": {
                  "14601": "Acém", "14625": "Alcatra com Maminha", "1762": "Bisteca com osso",
                  "14694": "Colchão Duro", "26390": "Colchão Mole", "25812": "Contra Filé",
                  "14793": "Coração da Alcatra", "4282": "Fígado", "14762": "Lagarto",
                  "14809": "Miolo da Paleta", "14618": "Músculo do Dianteiro", "14816": "Paleta",
                  "14823": "Patinho", "00260": "Picanha em Pedaços", "05418": "Picanha Grill",
                  "16094": "Picanha Maturada", "07160": "Picanha Todo Dia", "06019": "Picanha Tradicional"
                },
                "suinos": {
                  "11549": "Bisteca Suína", "23023": "Carne Suína Corte", "15776": "Carne Suína Embalada",
                  "23740": "Costela com Panceta Suína Corte", "23733": "Costela com Panceta Suína Embalada",
                  "18159": "Pé Suíno"
                }
            };
            rebuildProductIndexesAndSidebar();
            alert("Não foi possível carregar os dados online. Usando dados padrão.");
        }
    }

    async function saveProductData() {
        try {
            // Atualiza a data de última atualização
            const now = new Date();
            productData.meta = {
                version: productData.meta ? productData.meta.version : 1,
                last_updated: now.toISOString()
            };

            const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`, {
                method: 'POST', // POST para atualizar o bin existente no Pantry
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
            }
            console.log("Dados salvos com sucesso no Pantry!");
            return true;
        } catch (error) {
            console.error("Erro ao salvar dados no Pantry:", error);
            alert("Erro ao salvar o novo produto. Verifique seu Pantry ID ou nome da cesta. Você não deve usar a mesma cesta para vários projetos.");
            return false;
        }
    }

    function populateSidebarList(listElement, data) {
        listElement.innerHTML = ''; // Limpa a lista antes de preencher
        Object.entries(data).forEach(([code, name]) => {
            const li = document.createElement('li'); // Alterado para li
            li.classList.add('item');
            li.textContent = `${code.padStart(5, '0')} - ${name}`;
            li.tabIndex = 0;
            li.addEventListener('click', () => {
                showSection('mainTerminalSection');
                inputCode.value = code.padStart(5, '0');
                displayResult(name, true);
                // remove classes de sucesso/erro para que o estilo do feedback-icon não persista
                resultDiv.classList.remove('success', 'error');
                hamburger.classList.remove('open');
                sidebar.classList.remove('open');
                document.body.classList.remove('sidebar-open');
            });
            listElement.appendChild(li); // Adiciona li
        });
    }

    function rebuildProductIndexesAndSidebar() {
        productsInverseNormalized = {}; // Zera os índices

        // Recria os índices a partir dos dados carregados/atualizados
        Object.entries(productData.bovinos).forEach(([code, name]) => {
          productsInverseNormalized[normalizeText(name)] = {
              code: code.padStart(5, '0'),
              originalName: name
          };
        });
        Object.entries(productData.suinos).forEach(([code, name]) => {
          productsInverseNormalized[normalizeText(name)] = {
              code: code.padStart(5, '0'),
              originalName: name
          };
        });

        // Repopula a sidebar
        populateSidebarList(bovinosList, productData.bovinos);
        populateSidebarList(suinosList, productData.suinos);
    }

    // --- Lógica do Terminal ButcherCode ---
    function displayResult(text, isSuccess) {
        resultDiv.innerHTML = '';
        resultDiv.classList.remove('scrolling', 'success', 'error'); // Limpa classes

        const marqueeSpan = document.createElement('span');
        marqueeSpan.textContent = text;
        resultDiv.appendChild(marqueeSpan);

        // Ícone de feedback
        const icon = document.createElement('i');
        icon.classList.add('feedback-icon');
        icon.classList.add(isSuccess ? 'fa-check-circle' : 'fa-times-circle');
        icon.classList.add(isSuccess ? 'fas' : 'fa'); // FontAwesome solid ou regular
        resultDiv.appendChild(icon);

        if (isSuccess) {
            resultDiv.classList.add('success');
            playSound('terminalSuccess');
        } else {
            resultDiv.classList.add('error');
            playSound('terminalError');
        }

        setTimeout(() => {
            icon.classList.add('show');
        }, 50); // Pequeno atraso para a transição
        setTimeout(() => {
            icon.classList.remove('show');
            icon.remove(); // Remove o ícone após a animação
        }, 1500);

        if (text.length > 15) { // Ativa marquee se o texto for longo
            marqueeSpan.classList.add('marquee');
            void resultDiv.offsetWidth; // Força reflow para reiniciar animação
            resultDiv.classList.add('scrolling');
        }
    }

    function buscarCodigoOuNome(input) {
      const texto = input.trim();
      if (!texto) return { result: "Nenhum valor digitado.", found: false };

      // Verifica se é um código (apenas números)
      if (/^\d+$/.test(texto)) {
        const codigo = texto.padStart(5, '0');
        const nomeProduto = productData.bovinos[codigo] || productData.suinos[codigo];
        return {
            result: nomeProduto || `Código "${codigo}" não encontrado.`,
            found: !!nomeProduto
        };
      } else {
        const normalizedInput = normalizeText(texto);
        const foundData = productsInverseNormalized[normalizedInput];
        return {
            result: foundData ? foundData.code : `Produto "${texto}" não encontrado.`,
            found: !!foundData
        };
      }
    }

    btnExecute.addEventListener('click', () => {
      const valor = inputCode.value;
      const { result, found } = buscarCodigoOuNome(valor);
      displayResult(result, found);
    });

    inputCode.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        btnExecute.click();
      }
    });

    inputCode.addEventListener('input', () => {
        resultDiv.innerHTML = '';
        resultDiv.classList.remove('scrolling', 'success', 'error');
    });

    // --- Lógica de Adicionar Novo Produto ---
    btnAddNewProduct.addEventListener('click', async () => {
        if (!currentUser) {
            addProductFeedback.textContent = 'Você precisa estar logado para adicionar produtos.';
            addProductFeedback.style.color = 'var(--cor-erro)';
            return;
        }

        const newCode = inputNewCode.value.trim();
        const newName = inputNewName.value.trim();
        const category = selectNewCategory.value;

        if (!newCode || !newName || !category) {
            addProductFeedback.textContent = 'Preencha todos os campos.';
            addProductFeedback.style.color = 'var(--cor-aviso)';
            return;
        }

        const formattedCode = newCode.padStart(5, '0');

        // Verificar se o código ou nome já existem em qualquer categoria
        if (productData.bovinos[formattedCode] || productData.suinos[formattedCode]) {
            addProductFeedback.textContent = `Código "${formattedCode}" já existente!`;
            addProductFeedback.style.color = 'var(--cor-erro)';
            return;
        }
        if (productsInverseNormalized[normalizeText(newName)]) {
             addProductFeedback.textContent = `Nome de produto "${newName}" já existente!`;
             addProductFeedback.style.color = 'var(--cor-erro)';
             return;
        }

        // Adicionar ao objeto de dados
        if (category === 'bovinos') {
            productData.bovinos[formattedCode] = newName;
        } else if (category === 'suinos') {
            productData.suinos[formattedCode] = newName;
        }

        // Salvar os dados no Pantry
        const success = await saveProductData();
        if (success) {
            addProductFeedback.textContent = `Produto "${newName}" (${formattedCode}) adicionado com sucesso em ${category}!`;
            addProductFeedback.style.color = 'var(--cor-sucesso)';
            inputNewCode.value = '';
            inputNewName.value = '';
            rebuildProductIndexesAndSidebar(); // Atualiza a sidebar
        } else {
            addProductFeedback.textContent = 'Erro ao adicionar produto. Tente novamente.';
            addProductFeedback.style.color = 'var(--cor-erro)';
        }

        setTimeout(() => { addProductFeedback.textContent = ''; }, 3000);
    });

    // --- Lógica de Comentários e Feedback (Firebase Firestore) ---
    submitCommentButton.addEventListener('click', async () => {
        if (!currentUser) {
            commentsFeedback.textContent = 'Você precisa estar logado para enviar um comentário.';
            commentsFeedback.style.color = 'var(--cor-erro)';
            return;
        }

        const commentText = commentInput.value.trim();
        if (!commentText) {
            commentsFeedback.textContent = 'O comentário não pode estar vazio.';
            commentsFeedback.style.color = 'var(--cor-aviso)';
            return;
        }

        try {
            const userDocRef = doc(db, 'users', currentUser.uid);
            const userDocSnap = await getDoc(userDocRef);
            const userData = userDocSnap.exists() ? userDocSnap.data() : null;
            const username = userData && userData.username ? userData.username : 'Anônimo'; // Pega o username real do Firestore

            await addDoc(collection(db, 'comments'), {
                userId: currentUser.uid,
                username: username,
                comment: commentText,
                timestamp: serverTimestamp()
            });

            commentsFeedback.textContent = 'Comentário enviado com sucesso!';
            commentsFeedback.style.color = 'var(--cor-sucesso)';
            commentInput.value = '';
            loadComments(); // Recarrega os comentários para exibir o novo

        } catch (error) {
            console.error("Erro ao enviar comentário:", error);
            commentsFeedback.textContent = `Erro ao enviar comentário: ${error.message}`;
            commentsFeedback.style.color = 'var(--cor-erro)';
        }
        setTimeout(() => { commentsFeedback.textContent = ''; }, 3000);
    });

    async function loadComments() {
        commentsList.innerHTML = '<p style="text-align: center; color: var(--cor-texto-secundario);">Carregando comentários...</p>';
        try {
            const commentsCollectionRef = collection(db, 'comments');
            const q = query(commentsCollectionRef, orderBy('timestamp', 'desc'), limit(20));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                commentsList.innerHTML = '<p style="text-align: center; color: var(--cor-texto-secundario);">Nenhum comentário ainda. Seja o primeiro a deixar um!</p>';
                return;
            }

            commentsList.innerHTML = ''; // Limpa antes de adicionar

            querySnapshot.forEach(documentSnapshot => {
                const comment = documentSnapshot.data();
                const div = document.createElement('div');
                div.classList.add('comment-item');
                // Adiciona uma verificação para timestamp, caso seja nulo ou indefinido
                const date = comment.timestamp && comment.timestamp.toDate ? new Date(comment.timestamp.toDate()) : new Date();
                const formattedDate = date.toLocaleString('pt-BR');
                // Usa o username do comentário diretamente
                div.innerHTML = `<strong>${comment.username || 'Anônimo'}:</strong> ${comment.comment} <span class="timestamp">${formattedDate}</span>`;
                commentsList.appendChild(div);
            });

        } catch (error) {
            console.error("Erro ao carregar comentários:", error);
            commentsList.innerHTML = '<p style="text-align: center; color: var(--cor-erro);">Erro ao carregar comentários.</p>';
        }
    }


    // --- Gerenciamento da Visibilidade de Seções e Acordeão do Menu ---
    butcherCodeTitle.addEventListener('click', () => {
        showSection('initialScreen');
    });

    accessTerminalButton.addEventListener('click', () => {
        showSection('mainTerminalSection');
    });

    playGameCodeButton.addEventListener('click', () => {
        showSection('gameCodeSection');
    });

    viewCommentsButton.addEventListener('click', () => {
        showSection('commentsSection');
    });

    // Event listener para títulos da sidebar que alternam seções principais
    document.querySelector('[data-target="userProfileSection"]').addEventListener('click', () => {
        showSection('userProfileSection');
    });
    document.querySelector('[data-target="mainTerminalSection"]').addEventListener('click', () => {
        showSection('mainTerminalSection');
    });
    document.querySelector('[data-target="gameCodeSection"]').addEventListener('click', () => {
        showSection('gameCodeSection');
    });
    document.querySelector('[data-target="addProductSection"]').addEventListener('click', () => {
        showSection('addProductSection');
    });
    document.querySelector('[data-target="commentsSection"]').addEventListener('click', () => {
        showSection('commentsSection');
    });


    // Event listeners para botões de "Voltar ao Início"
    backToHomeTerminalButton.addEventListener('click', () => {
        showSection('initialScreen');
    });

    backToHomeGameButton.addEventListener('click', () => {
        showSection('initialScreen');
    });

    backToHomeAddProductButton.addEventListener('click', () => {
        showSection('initialScreen');
    });

    backToHomeCommentsButton.addEventListener('click', () => {
        showSection('initialScreen');
    });

    backToHomeProfileButton.addEventListener('click', () => {
        showSection('initialScreen');
    });


    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('open');
      sidebar.classList.toggle('open');
      document.body.classList.toggle('sidebar-open');
    });

    document.addEventListener('click', e => {
      // Se o clique não foi na sidebar, nem no hambúrguer, nem no modal, nem no título
      if (!sidebar.contains(e.target) && !hamburger.contains(e.target) && !authModalOverlay.contains(e.target) && e.target !== butcherCodeTitle) {
        hamburger.classList.remove('open');
        sidebar.classList.remove('open');
        document.body.classList.remove('sidebar-open');
      }
    });

    sidebarTitles.forEach(title => {
      title.addEventListener('click', () => {
        const targetId = title.dataset.target;
        const contentType = title.dataset.type;
        const targetElement = document.getElementById(targetId);

        if (contentType === 'accordion') {
            // Fecha o acordeão ativo se for diferente do clicado
            if (activeAccordionItem && activeAccordionItem !== targetElement) {
                activeAccordionItem.classList.remove('open');
                activeAccordionItem.previousElementSibling.classList.remove('open');
            }

            targetElement.classList.toggle('open');
            title.classList.toggle('open');
            activeAccordionItem = targetElement.classList.contains('open') ? targetElement : null;

            // Para o timer do jogo se um acordeão for aberto
            clearInterval(timerInterval);
            clearInterval(tickSoundInterval);
            timeLeft = TIME_PER_QUESTION;
            progressBar.style.width = '100%';
        } else if (contentType === 'main-content') {
            showSection(targetId);
            // Fecha todos os acordeões ao mudar para uma seção de conteúdo principal
            document.querySelectorAll('.subfolder').forEach(folder => {
                folder.classList.remove('open');
                folder.previousElementSibling.classList.remove('open'); // O h2 que controla
            });
            activeAccordionItem = null;
        }
      });
    });


    // --- Lógica do GameCode ---
    // Gerar perguntas dinamicamente a partir dos dados carregados
    function generateQuestions() {
        const allProducts = { ...productData.bovinos, ...productData.suinos };
        const productEntries = Object.entries(allProducts);
        const generated = [];

        // Limita o número de perguntas se houver poucos produtos
        const numQuestions = Math.min(20, productEntries.length * 2);

        if (productEntries.length < 2) {
            // Precisa de pelo menos 2 produtos para gerar opções válidas (correta + 1 alternativa)
            console.warn("Poucos produtos para gerar perguntas do GameCode.");
            return [];
        }

        for (let i = 0; i < numQuestions; i++) {
            const type = Math.random() < 0.5 ? 'codeToName' : 'nameToCode';
            
            // Seleciona uma pergunta correta aleatoriamente
            const [correctCode, correctName] = productEntries[Math.floor(Math.random() * productEntries.length)];

            let questionText, correctAnswer;
            let options = new Set(); // Usa Set para evitar opções duplicadas

            if (type === 'codeToName') {
                questionText = `Qual o nome do produto com o código: ${correctCode.padStart(5, '0')}?`;
                correctAnswer = correctName;
            } else { // nameToCode
                questionText = `Qual o código do produto: ${correctName}?`;
                correctAnswer = correctCode.padStart(5, '0');
            }
            options.add(correctAnswer); // Adiciona a resposta correta

            // Gera 3 opções extras aleatórias que não sejam a resposta correta
            while (options.size < 4) {
                const [randomCode, randomName] = productEntries[Math.floor(Math.random() * productEntries.length)];
                let randomOption;
                if (type === 'codeToName') {
                    randomOption = randomName;
                } else {
                    randomOption = randomCode.padStart(5, '0');
                }
                
                if (randomOption !== correctAnswer && randomOption !== undefined && randomOption !== null && randomOption !== '') {
                    options.add(randomOption);
                }
            }

            const shuffledOptions = Array.from(options);
            shuffleArray(shuffledOptions); // Embaralha as opções

            generated.push({
                question: questionText,
                options: shuffledOptions,
                correctAnswer: correctAnswer
            });
        }
        return generated;
    }


    function saveGameState() {
        const gameState = {
            currentQuestionIndex: currentQuestionIndex,
            score: score,
            questions: questions,
            timeLeft: timeLeft
        };
        localStorage.setItem(GAME_STATE_KEY, JSON.stringify(gameState));
    }

    function loadGameState() {
        const savedState = localStorage.getItem(GAME_STATE_KEY);
        if (savedState) {
            try {
                const gameState = JSON.parse(savedState);
                // Valida para evitar dados corrompidos
                if (gameState && typeof gameState.currentQuestionIndex === 'number' && typeof gameState.score === 'number' && Array.isArray(gameState.questions) && typeof gameState.timeLeft === 'number') {
                    currentQuestionIndex = gameState.currentQuestionIndex;
                    score = gameState.score;
                    questions = gameState.questions;
                    timeLeft = (gameState.timeLeft > 0 && gameState.timeLeft <= TIME_PER_QUESTION) ? gameState.timeLeft : TIME_PER_QUESTION;
                    console.log("Estado do jogo carregado.");
                    return true;
                }
            } catch (e) {
                console.error("Erro ao carregar estado do jogo:", e);
                localStorage.removeItem(GAME_STATE_KEY); // Limpa estado corrompido
            }
        }
        return false;
    }

    function startTimer() {
        clearInterval(timerInterval);
        clearInterval(tickSoundInterval);

        timeLeft = (timeLeft === undefined || timeLeft === null || timeLeft <= 0 || timeLeft > TIME_PER_QUESTION) ? TIME_PER_QUESTION : timeLeft;

        timerElement.textContent = `Tempo: ${timeLeft}s`;
        timerElement.classList.remove('warning', 'critical');
        progressBar.style.width = `${(timeLeft / TIME_PER_QUESTION) * 100}%`;

        // Toca o som de "tick" nos últimos 5 segundos
        if (timeLeft <= 5 && timeLeft > 0) {
            tickSoundInterval = setInterval(() => {
                if (timeLeft > 0) playSound('tick');
            }, 1000);
        }

        timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.textContent = `Tempo: ${timeLeft}s`;
            const progress = (timeLeft / TIME_PER_QUESTION) * 100;
            progressBar.style.width = `${progress}%`;

            if (timeLeft <= 5 && timeLeft > 0) {
                timerElement.classList.add('warning');
                timerElement.classList.remove('critical');
                if (!tickSoundInterval) { // Garante que o interval só seja criado uma vez
                     tickSoundInterval = setInterval(() => {
                        if (timeLeft > 0) playSound('tick');
                    }, 1000);
                }
            } else if (timeLeft <= 0) {
                clearInterval(timerInterval);
                clearInterval(tickSoundInterval);
                timerElement.textContent = "Tempo esgotado!";
                timerElement.classList.add('critical');
                checkAnswer(null); // Resposta incorreta por tempo esgotado
            } else {
                timerElement.classList.remove('warning', 'critical');
                clearInterval(tickSoundInterval); // Limpa o tick se o tempo subir (ex: ao reiniciar)
                tickSoundInterval = null;
            }
            saveGameState();
        }, 1000);
    }

    function showQuestion() {
      if (currentQuestionIndex < questions.length) {
        timeLeft = TIME_PER_QUESTION; // Reseta o tempo para a nova pergunta
        startTimer();

        const currentQuestion = questions[currentQuestionIndex];
        questionElement.textContent = currentQuestion.question;
        optionsElement.innerHTML = '';
        currentQuestion.options.forEach(option => {
          const button = document.createElement('button');
          button.textContent = option;
          button.dataset.answer = option;
          button.addEventListener('click', checkAnswer);
          optionsElement.appendChild(button);
        });
        feedbackElement.textContent = '';
        feedbackElement.className = '';
        nextQuestionButton.style.display = 'none'; // Esconde o botão "Próxima Pergunta"

        questionCounterElement.textContent = `Pergunta ${currentQuestionIndex + 1} de ${questions.length}`;

        // Calcula a porcentagem de acertos com base nas perguntas já tentadas
        const totalQuestionsAttempted = currentQuestionIndex; // Perguntas já respondidas
        const percentage = totalQuestionsAttempted > 0 ? (((score / totalQuestionsAttempted) * 100) || 0).toFixed(0) : 0;
        scoreDisplayElement.textContent = `Pontuação: ${score}/${totalQuestionsAttempted} (${percentage}%)`;

        saveGameState();
      } else {
        endGame(false); // Fim do jogo por ter respondido todas as perguntas
      }
    }

    function checkAnswer(event) {
      clearInterval(timerInterval); // Para o timer ao responder
      clearInterval(tickSoundInterval); // Para o som de tick

      const currentQuestion = questions[currentQuestionIndex];
      const correctAnswer = currentQuestion.correctAnswer;
      let selectedAnswer = null;

      if (event && event.target) { // Se a resposta veio de um clique no botão
        selectedAnswer = event.target.dataset.answer;
      }

      optionsElement.querySelectorAll('button').forEach(button => {
        button.disabled = true; // Desabilita todos os botões após a resposta
        if (button.dataset.answer === correctAnswer) {
          button.style.backgroundColor = 'var(--cor-botao-hover)'; // Destaca a correta
        } else if (button.dataset.answer === selectedAnswer) {
          button.style.backgroundColor = '#660000'; // Destaca a incorreta que foi selecionada
        }
      });

      if (selectedAnswer === correctAnswer) {
        feedbackElement.textContent = 'Correto!';
        feedbackElement.className = 'correct';
        score++;
        playSound('correct');
      } else {
        feedbackElement.textContent = `Incorreto. A resposta correta era: ${currentQuestion.correctAnswer}`;
        feedbackElement.className = 'incorrect';
        playSound('incorrect');
      }

      currentQuestionIndex++; // Avança para a próxima pergunta

      // Atualiza a pontuação exibida
      const totalQuestionsAttempted = currentQuestionIndex;
      const percentage = totalQuestionsAttempted > 0 ? (((score / totalQuestionsAttempted) * 100) || 0).toFixed(0) : 0;
      scoreDisplayElement.textContent = `Pontuação: ${score}/${totalQuestionsAttempted} (${percentage}%)`;

      nextQuestionButton.style.display = 'block'; // Mostra o botão para ir para a próxima pergunta
      saveGameState();
    }

    function nextQuestion() {
      feedbackElement.textContent = '';
      feedbackElement.className = '';
      optionsElement.querySelectorAll('button').forEach(button => {
          button.style.backgroundColor = 'var(--cor-botao-fundo)'; // Restaura a cor padrão
          button.disabled = false; // Reabilita os botões para a próxima pergunta
      });
      showQuestion();
    }


    function endGame(earlyExit = false) {
      clearInterval(timerInterval);
      clearInterval(tickSoundInterval);
      gameElements.style.display = 'none';
      gameEndScreen.style.display = 'flex';
      playSound('gameEnd');

      const totalQuestionsAttempted = currentQuestionIndex;

      const finalPercentage = totalQuestionsAttempted > 0 ? ((score / totalQuestionsAttempted) * 100).toFixed(0) : 0;

      let message = "Sua pontuação final foi: ";
      if (earlyExit) {
          message = "Você finalizou o jogo antecipadamente! <br>Sua pontuação parcial foi: ";
      }

      finalScoreMessage.innerHTML = `${message}<br><span style="font-size: 2em; color: ${finalPercentage >= 70 ? 'var(--cor-sucesso)' : (finalPercentage >= 40 ? 'var(--cor-aviso)' : 'var(--cor-critico)')};">${score} de ${totalQuestionsAttempted} (${finalPercentage}%)</span>`;

      // Limpa displays do jogo
      scoreDisplayElement.textContent = '';
      questionCounterElement.textContent = '';
      timerElement.textContent = '';
      progressBar.style.width = '100%'; // Garante que a barra esteja cheia no final

      localStorage.removeItem(GAME_STATE_KEY); // Limpa o estado salvo do jogo
    }

    function startGame() {
      gameStartScreen.style.display = 'none';
      gameEndScreen.style.display = 'none';
      gameElements.style.display = 'block';
      playSound('gameStart');

      // Tenta carregar o estado, se não houver ou o jogo anterior tiver terminado, inicia um novo
      if (!loadGameState() || questions.length === 0 || currentQuestionIndex >= questions.length) {
          currentQuestionIndex = 0;
          score = 0;
          questions = generateQuestions();
          shuffleArray(questions); // Embaralha as perguntas
          localStorage.removeItem(GAME_STATE_KEY); // Limpa qualquer estado antigo
          timeLeft = TIME_PER_QUESTION; // Reseta o tempo para a primeira pergunta
      }

      // Verifica se há perguntas para jogar
      if (questions.length === 0) {
          gameElements.style.display = 'none';
          gameStartScreen.style.display = 'flex';
          gameStartScreen.querySelector('h3').textContent = 'Atenção!';
          gameStartScreen.querySelector('p').innerHTML = 'Não há produtos suficientes para gerar perguntas. Adicione mais produtos na seção "Adicionar Produto" para começar a jogar!';
          startGameButton.style.display = 'none'; // Esconde o botão de iniciar se não houver perguntas
          return;
      } else {
          startGameButton.style.display = 'block'; // Mostra o botão se houver perguntas
          gameStartScreen.querySelector('h3').textContent = 'Bem-vindo ao GameCode!'; // Restaura o título
          gameStartScreen.querySelector('p').innerHTML = 'Teste seus conhecimentos sobre os códigos de açougue.<br>Você terá 15 segundos para responder a cada uma das 20 perguntas.'; // Restaura o texto
      }

      scoreDisplayElement.textContent = '';
      nextQuestionButton.textContent = 'Próxima Pergunta';
      nextQuestionButton.removeEventListener('click', startGame); // Remove listener antigo se houver
      nextQuestionButton.addEventListener('click', nextQuestion); // Adiciona listener para a próxima pergunta

      optionsElement.querySelectorAll('button').forEach(button => {
          button.style.backgroundColor = 'var(--cor-botao-fundo)';
          button.disabled = false;
      });

      showQuestion(); // Exibe a primeira pergunta ou a pergunta do estado salvo
    }

    // --- Listeners de Eventos do GameCode ---
    startGameButton.addEventListener('click', startGame);
    restartGameButton.addEventListener('click', startGame);
    endGameButton.addEventListener('click', () => endGame(true));


    // --- Carregamento inicial de dados ao carregar a página ---
    loadProductData(); 
    showSection('initialScreen'); // Garante que a tela inicial é exibida ao carregar
  }); // Fim do DOMContentLoaded
</script>
</body>
</html>
