<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ButcherCode</title>
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-o6p4D+E2n9B0o2k2yX2b/f/2q+6a+8+z3f6q3g+4y+5t6u7p8s9w=" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* Paleta Corte Nobre */
    :root {
      --cor-fundo-principal: #F6F3ED;      /* Bege muito claro, como papel manteiga ou osso */
      --cor-fundo-secundario: #FFFFFF;     /* Branco puro, para áreas de conteúdo e modais */
      --cor-texto-principal: #4A3B31;      /* Marrom muito escuro, quase preto, como madeira escura */
      --cor-texto-secundario: #796A5F;    /* Marrom acinzentado médio */
      
      --cor-header-fundo: #7D0000;        /* Vermelho Bordô/Vinho intenso (clássico e sóbrio) */
      --cor-header-texto: #F5EFE6;        /* Creme/Bege bem claro para contraste */

      --cor-sidebar-fundo: #B8977E;       /* Marrom madeira médio, como um cepo ou balcão */
      --cor-sidebar-texto: #F5EFE6;       /* Creme/Bege bem claro para texto na sidebar (matches header text) */
      --cor-sidebar-borda: rgba(245, 239, 230, 0.25); /* Borda sutil do texto da sidebar na sidebar */
      --cor-sidebar-link-hover-fundo: #A07E60; /* Tom de madeira um pouco mais escuro */

      --cor-borda-geral: #D4C8BE;         /* Bege acinzentado claro para bordas sutis */
      
      --cor-input-fundo: #FFFFFF;
      --cor-input-borda: #C8BBAF;         /* Bege acinzentado para bordas de input */
      --cor-input-texto: var(--cor-texto-principal);
      --cor-input-placeholder: #A8998E;   /* Bege acinzentado mais claro para placeholder */
      --cor-input-foco-borda: #A84932;    /* Vermelho terracota/tijolo para foco */
      --cor-input-foco-sombra: rgba(168, 73, 50, 0.2);

      --cor-botao-primario-fundo: #C62828; /* Vermelho forte e direto (como carne fresca) */
      --cor-botao-primario-hover: #A92020; /* Vermelho mais escuro para hover */
      --cor-botao-primario-texto: #FFFFFF;

      --cor-botao-secundario-fundo: #EFEBE4; /* Bege claro, como papel de açougue */
      --cor-botao-secundario-hover: #E0D8CF; /* Bege um pouco mais escuro */
      --cor-botao-secundario-texto: var(--cor-texto-principal);
      --cor-botao-secundario-borda: #D0C4B9;

      --cor-link-padrao: #9A3E2A;          /* Vermelho terroso/ferrugem para links */
      --cor-link-hover: #7D0000;           /* Bordô (igual ao header) para hover forte */

      --cor-destaque: #B08D57;             /* Dourado envelhecido/Mostarda para pequenos destaques de qualidade */
      
      --cor-sucesso: #556B2F;              /* Verde Oliva Escuro */
      --cor-sucesso-fundo: rgba(85, 107, 47, 0.1);
      --cor-aviso: #DAA520;                /* Amarelo Goldenrod (clássico) */
      --cor-aviso-fundo: rgba(218, 165, 32, 0.15);
      --cor-erro: #B22222;                /* Vermelho Firebrick (forte e clássico) */
      --cor-erro-fundo: rgba(178, 34, 34, 0.1);
      
      --cor-modal-fundo: var(--cor-fundo-secundario);
      --cor-modal-sombra: rgba(74, 59, 49, 0.2); 

      --cor-admin-username: var(--cor-destaque); 
      --cor-cooperator-username: #8B4513;  /* Marrom "SaddleBrown" */
      --cor-botao-admin-perigo-fundo: var(--cor-erro);
      --cor-botao-admin-perigo-hover: #8B0000; /* Vermelho Bordô Escuro (DarkRed) */
    }

    body {
      margin: 0;
      background: var(--cor-fundo-principal);
      color: var(--cor-texto-principal);
      font-family: 'Source Code Pro', monospace;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      transition: background 0.3s ease, color 0.3s ease; 
      padding-bottom: 20px;
    }
    
    main {
      margin: 100px 30px 30px 30px;
      max-width: 700px;
      transition: margin-left 0.3s ease, background-color 0.3s ease, opacity 0s, visibility 0s; 
      padding: 25px;
      background-color: var(--cor-fundo-secundario);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(74, 59, 49, 0.1); 
      opacity: 1; 
      visibility: visible; 
    }

    body.sidebar-open main {
      margin-left: 320px;  
      opacity: 0;          
      visibility: hidden;    
      pointer-events: none;  
    }

    header {
      background: var(--cor-header-fundo);
      color: var(--cor-header-texto);
      padding: 15px 30px;
      display: flex;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1001;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15); 
      transition: background 0.3s ease;
      justify-content: space-between;
    }
    #hamburger {
      cursor: pointer;
      width: 35px;
      height: 26px;
      position: relative;
    }
    #hamburger span {
      background: var(--cor-header-texto);
      position: absolute;
      height: 3px;
      width: 100%;
      left: 0;
      border-radius: 2px;
      transition: 0.3s ease, background 0.3s ease;
    }
    #hamburger span:nth-child(1) { top: 0; }
    #hamburger span:nth-child(2) { top: 11px; }
    #hamburger span:nth-child(3) { top: 22px; }
    #hamburger.open span:nth-child(1) { transform: rotate(45deg); top: 11px; }
    #hamburger.open span:nth-child(2) { opacity: 0; }
    #hamburger.open span:nth-child(3) { transform: rotate(-45deg); top: 11px; }

    h1#butcherCodeTitle {
      margin: 0;
      font-size: 2.2rem;
      font-weight: bold;
      animation: fadeInScale 1s ease forwards; 
      flex-grow: 1;
      text-align: center;
      cursor: pointer;
      user-select: none;
      margin-right: 35px; 
      color: var(--cor-header-texto);
      opacity: 1;
      visibility: visible;
    }
    @keyframes fadeInScale {
      0% { opacity: 0; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1); }
    }

    body.sidebar-open header h1#butcherCodeTitle {
      opacity: 0;
      visibility: hidden;
      pointer-events: none; 
    }

    #sidebar {
      position: fixed;
      top: 65px; 
      left: 0;
      width: 300px;
      height: calc(100vh - 65px);
      background: var(--cor-sidebar-fundo);
      color: var(--cor-sidebar-texto);
      overflow-y: auto;
      z-index: 1000;
      padding-top: 25px; 
      padding-right: 20px;
      padding-bottom: 20px;
      padding-left: 20px;
      transform: translateX(-100%);
      transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
      box-shadow: 2px 0 5px rgba(74, 59, 49, 0.15); 
    }
    #sidebar.open { transform: translateX(0); }
    #sidebar h2 {
      margin-top: 0;
      font-size: 1.4rem;
      border-bottom: 1px solid var(--cor-sidebar-borda);
      padding-bottom: 8px;
      margin-bottom: 15px;
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 25px;
      transition: border-color 0.3s ease, color 0.3s ease;
      color: var(--cor-sidebar-texto);
    }
    #sidebar h2::after {
      content: "▶";
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%); 
      transition: transform 0.3s ease;
      color: var(--cor-sidebar-texto);
    }
    #sidebar h2.open::after { transform: translateY(-50%) rotate(90deg); }

    .menu-sections { list-style: none; padding: 0; margin: 0; }
    .menu-section { margin-bottom: 25px; }
    .subfolder {
      margin-left: 20px;
      display: none;
      margin-bottom: 12px;
      list-style: none;
      padding: 0;
    }
    .subfolder.open { display: block; }
    .subfolder .item {
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 4px;
      margin-bottom: 5px;
      color: var(--cor-sidebar-texto);
      transition: background-color 0.2s ease;
    }
    .subfolder .item:hover {
      background: var(--cor-sidebar-link-hover-fundo);
    }

    #mainTerminalSection, #gameCodeSection, #initialScreen, #addProductSection,
    #commentsSection, #userProfileSection, #adminProductManagementSection, #adminUserManagementSection,
    #gamesHubSection, #flashcardGameSection, #instructionsSection { display: none; }


    main.show-terminal #mainTerminalSection { display: block; }
    main.show-game #gameCodeSection { display: block; }
    main.show-initial #initialScreen { display: block; }
    main.show-add-product #addProductSection { display: block; }
    main.show-comments #commentsSection { display: block; }
    main.show-profile #userProfileSection { display: block; }
    main.show-admin-products #adminProductManagementSection { display: block; }
    main.show-admin-users #adminUserManagementSection { display: block; } /* Nova classe */
    main.show-games-hub #gamesHubSection { display: block; }
    main.show-flashcard-game #flashcardGameSection { display: block; }
    main.show-instructions #instructionsSection { display: block; }


    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--cor-texto-principal);
    }
    .input-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }
    input, button, select, textarea {
      padding: 10px 12px;
      font-size: 1rem;
      border-radius: 4px;
      font-family: 'Source Code Pro', monospace;
      border: 1px solid var(--cor-input-borda);
    }
    input::placeholder, textarea::placeholder { color: var(--cor-input-placeholder); }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--cor-input-foco-borda);
      box-shadow: 0 0 0 0.15rem var(--cor-input-foco-sombra);
    }
    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      background: var(--cor-input-fundo);
      color: var(--cor-input-texto);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    select {
        margin-top: 5px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23796A5F%22%20d%3D%22M287%2069.9a17.6%2017.6%200%200%200-24.8%200L146.2%20185.7%2030.2%2069.9a17.6%2017.6%200%200%200-24.8%2024.8l139%20139.1a17.6%2017.6%200%200%200%2024.8%200l139-139.1a17.6%2017.6%200%200%200%200-24.8z%22%2F%3E%3C%2Fsvg%3E'); 
        background-repeat: no-repeat;
        background-position: right 10px top 50%;
        background-size: 12px auto;
        padding-right: 30px;
    }

    button {
      margin-top: 0px;
      background: var(--cor-botao-primario-fundo);
      color: var(--cor-botao-primario-texto);
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
      width: 100%;
      font-size: 1.05rem;
      padding: 10px 15px;
      border-radius: 4px;
      font-weight: 500;
    }
    button:hover {
      background: var(--cor-botao-primario-hover);
      transform: translateY(-1px);
    }
    button.admin-delete-button, .delete-product-btn, .delete-user-btn { /* Adicionado .delete-user-btn */
        background-color: var(--cor-botao-admin-perigo-fundo);
        color: var(--cor-botao-primario-texto);
        padding: 6px 12px;
        font-size: 0.9rem;
        margin-left: 10px;
        margin-top: 5px;
        width: auto;
        display: inline-block;
    }
    button.admin-delete-button:hover, .delete-product-btn:hover, .delete-user-btn:hover { /* Adicionado .delete-user-btn */
        background-color: var(--cor-botao-admin-perigo-hover);
    }
    .edit-product-btn {
        background-color: var(--cor-aviso);
        color: var(--cor-texto-principal); 
        padding: 6px 12px;
        font-size: 0.9rem;
        margin-left: 10px;
        margin-top: 5px;
        width: auto;
        display: inline-block;
    }
    .edit-product-btn:hover {
        background-color: #CF8E1B; 
    }


    #result {
      margin-top: 25px;
      min-height: 40px;
      font-size: 1.5rem;
      font-weight: 600;
      border: 1px solid var(--cor-borda-geral);
      padding: 12px;
      border-radius: 6px;
      background: var(--cor-fundo-secundario);
      white-space: nowrap;
      overflow: hidden;
      position: relative;
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    #result .marquee {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 10s linear infinite;
      animation-play-state: paused;
      transform: translateX(100%);
    }
    #result.scrolling .marquee { animation-play-state: running; }
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    #result .feedback-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.6em;
        opacity: 0;
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    #result.success .feedback-icon.show { opacity: 1; color: var(--cor-sucesso); transform: translateY(-50%) scale(1.1); }
    #result.error .feedback-icon.show { opacity: 1; color: var(--cor-erro); transform: translateY(-50%) scale(1.1); }

    #authModalOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.45); 
      display: none;
      justify-content: center; align-items: center;
      z-index: 9999;
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #authModalOverlay.show { opacity: 1; visibility: visible; display: flex; }
    #authModal {
      background: var(--cor-modal-fundo);
      padding: 30px 40px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 5px 20px var(--cor-modal-sombra);
      max-width: 400px; width: 90%;
      color: var(--cor-texto-principal);
      transform: translateY(-20px);
      transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    #authModalOverlay.show #authModal { transform: translateY(0); }
    #authModal h2 { margin-top: 0; font-size: 1.7rem; color: var(--cor-botao-primario-fundo); margin-bottom: 20px; }
    #passwordInput, #usernameInput {
        font-size: 1rem;
        text-align: center;
        margin-bottom: 15px;
    }
    #authSubmit, #registerButton {
      padding: 10px 25px;
      font-size: 1rem;
      margin-bottom: 10px;
    }
     #registerButton {
      background-color: var(--cor-botao-secundario-fundo);
      color: var(--cor-botao-secundario-texto);
      border: 1px solid var(--cor-botao-secundario-borda);
    }
    #registerButton:hover {
      background-color: var(--cor-botao-secundario-hover);
    }
    #authError { color: var(--cor-erro); margin-top: 10px; font-size: 0.9rem; min-height: 20px; }

    .close-modal-button {
        position: absolute;
        top: 12px;
        right: 15px;
        font-size: 2rem;
        color: var(--cor-texto-secundario);
        cursor: pointer;
        line-height: 1;
        padding: 5px;
        transition: color 0.3s ease;
    }
    .close-modal-button:hover {
        color: var(--cor-texto-principal);
    }

    #welcomeMessage {
      font-size: 1.8rem; font-weight: 600; color: var(--cor-texto-principal);
      opacity: 0; transition: opacity 0.5s ease; pointer-events: none;
      margin-bottom: 25px;
      min-height: 3em;
    }
    #welcomeMessage.show { opacity: 1; pointer-events: auto; }
    #initial-screen-options {
      display: flex; flex-direction: column; gap: 15px; margin-top: 30px;
      opacity: 0; visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
      padding: 0 20px; box-sizing: border-box;
    }
    #initial-screen-options.show { opacity: 1; visibility: visible; }
    #initial-screen-options button {
      background-color: var(--cor-botao-primario-fundo);
      color: var(--cor-botao-primario-texto);
      padding: 12px 20px;
      font-size: 1.2rem;
      border: none; border-radius: 6px;
      cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease;
      box-shadow: 0 1px 3px rgba(74, 59, 49, 0.15); 
    }
    #initial-screen-options button:hover {
      background-color: var(--cor-botao-primario-hover);
      transform: translateY(-2px);
    }

    #result.success { border-color: var(--cor-sucesso); background-color: var(--cor-sucesso-fundo); color: var(--cor-sucesso); }
    #result.error { border-color: var(--cor-erro); background-color: var(--cor-erro-fundo); color: var(--cor-erro); }

    #game-container { padding: 20px; background-color: var(--cor-fundo-secundario); border-radius: 6px; color: var(--cor-texto-principal); text-align: center; }
    #question { font-size: 1.1rem; margin-bottom: 20px; min-height: 3em; display: flex; align-items: center; justify-content: center; text-align: center; }
    #options button {
      display: block; width: 100%; padding: 10px; margin-bottom: 8px;
      background-color: var(--cor-botao-secundario-fundo);
      color: var(--cor-botao-secundario-texto);
      border: 1px solid var(--cor-botao-secundario-borda);
      border-radius: 4px; cursor: pointer; font-family: 'Source Code Pro', monospace;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #options button:hover:not(:disabled) { background-color: var(--cor-botao-secundario-hover); }
    #options button:disabled { cursor: not-allowed; opacity: 0.7; }
    #options button[style*="var(--cor-sucesso)"] { color: white !important; font-weight: bold; }
    #options button[style*="var(--cor-erro)"] { color: white !important; }
    #feedback { margin-top: 15px; font-weight: 600; min-height: 2em; }
    #feedback.correct { color: var(--cor-sucesso); }
    #feedback.incorrect { color: var(--cor-erro); }
    #score-display { margin-top: 15px; font-weight: 600; font-size: 1.05rem; min-height: 1.5em; }
    #next-question, #end-game-button, #start-game-button, #restart-game-button {
        font-family: 'Source Code Pro', monospace; margin-top: 20px; padding: 10px 20px; font-weight: 500;
    }
    #next-question, #start-game-button, #restart-game-button {
        background-color: var(--cor-botao-primario-fundo); color: var(--cor-botao-primario-texto);
    }
    #next-question:hover, #start-game-button:hover, #restart-game-button:hover { background-color: var(--cor-botao-primario-hover); }
    #end-game-button { background-color: var(--cor-erro); color: var(--cor-botao-primario-texto); }
    #end-game-button:hover { background-color: var(--cor-botao-admin-perigo-hover); }
    #game-start-screen, #game-end-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; background-color: var(--cor-fundo-secundario); border-radius: 8px; min-height: 200px; }
    #game-start-screen h3, #game-end-screen h3 { font-size: 1.8rem; color: var(--cor-texto-principal); margin-bottom: 20px; }
    #game-end-screen p { font-size: 1.2rem; margin-top: 10px; margin-bottom: 20px; }
    #progress-bar-container { width: 100%; background-color: var(--cor-borda-geral); border-radius: 5px; margin-top: 15px; overflow: hidden; height: 10px; position: relative; }
    #progress-bar { height: 100%; width: 0%; background-color: var(--cor-sucesso); border-radius: 5px; transition: width 0.1s linear, background-color 0.3s ease; }
    #timer { font-size: 1.2rem; font-weight: 600; margin-top: 10px; color: var(--cor-texto-secundario); transition: color 0.3s ease; }
    #timer.warning { color: var(--cor-aviso); }
    #timer.critical { color: var(--cor-erro); }
    #question-counter { font-size: 0.9em; color: var(--cor-texto-secundario); transition: color 0.3s ease; }

    .back-to-home-button {
      display: block; margin-top: 30px; width: 100%;
      padding: 10px 15px; background-color: var(--cor-botao-secundario-fundo);
      color: var(--cor-botao-secundario-texto); border: 1px solid var(--cor-botao-secundario-borda);
      border-radius: 4px; font-size: 1rem; cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease, color 0.3s ease; font-weight: 500;
    }
    .back-to-home-button:hover { background-color: var(--cor-botao-secundario-hover); transform: translateY(-2px); }

    #addProductSection, #commentsSection, #userProfileSection, #adminProductManagementSection, 
    #adminUserManagementSection, /* Nova seção */
    #gamesHubSection, #flashcardGameSection, #instructionsSection {
      padding: 25px; background-color: var(--cor-fundo-secundario);
      border-radius: 8px; margin-top: 30px; color: var(--cor-texto-principal);
    }
    #addProductSection h2, #commentsSection h2, #userProfileSection h2, #adminProductManagementSection h2,
    #adminUserManagementSection h2, /* Nova seção */
    #gamesHubSection h2, #flashcardGameSection h2, #instructionsSection h2 {
      color: var(--cor-botao-primario-fundo); font-size: 1.6rem; margin-bottom: 20px;
      border-bottom: 1px solid var(--cor-borda-geral); padding-bottom: 10px;
    }

    #addProductSection label { margin-bottom: 5px; color: var(--cor-texto-principal); }
    #addProductSection input[type="number"] { -moz-appearance: textfield; }
    #addProductSection input::-webkit-outer-spin-button, #addProductSection input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    #addProductSection input, #addProductSection select { margin-bottom: 15px; }

    #commentsSection textarea { margin-bottom: 15px; min-height: 100px; resize: vertical; }
    #commentsList { margin-top: 20px; border-top: 1px dashed var(--cor-borda-geral); padding-top: 15px; }
    .comment-item {
      position: relative; background-color: #FDFDFD; border: 1px solid var(--cor-borda-geral);
      border-radius: 6px; padding: 10px 15px; margin-bottom: 10px; word-wrap: break-word;
      transition: background-color 0.3s ease;
    }
    .comment-item strong { color: var(--cor-link-padrao); }
    .comment-item span.timestamp { font-size: 0.8em; color: var(--cor-texto-secundario); display: block; margin-top: 5px; }
    #commentsFeedback { margin-top: 10px; font-weight: bold; }
    #commentsFeedback.correct { color: var(--cor-sucesso); }
    #commentsFeedback.error { color: var(--cor-erro); }
    #commentsFeedback.warning { color: var(--cor-aviso); }

    #usernameDisplay { font-size: 1.3rem; font-weight: 600; color: var(--cor-texto-principal); margin-bottom: 15px; }
    #cooperatorStatusText { color: var(--cor-cooperator-username); font-weight: bold; display: none; }
    #adminStatusText { color: var(--cor-admin-username); font-weight: bold; display: none; }
    .profile-action-button {
        background-color: var(--cor-botao-secundario-fundo); color: var(--cor-botao-secundario-texto);
        border: 1px solid var(--cor-botao-secundario-borda); padding: 10px 15px; font-size: 1rem;
        border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease;
        margin-bottom: 10px; width: auto; margin-right: 10px; font-weight: 500;
    }
    .profile-action-button:last-child { margin-right: 0; }
    .profile-action-button:hover { background-color: var(--cor-botao-secundario-hover); transform: translateY(-1px); }

    #adminProductManagementSection .product-list-admin li,
    #adminUserManagementSection .user-list-admin li { /* Estilo unificado para listas de admin */
        background-color: #FAFAFA; border: 1px solid var(--cor-borda-geral); padding: 10px 15px;
        margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
    }
    #adminProductManagementSection .product-list-admin li .product-info,
    #adminUserManagementSection .user-list-admin li .user-info { /* Estilo unificado para info */
        flex-grow: 1;
    }
    #adminProductManagementFeedback, #adminUserManagementFeedback { /* Estilo unificado para feedback */
        margin-top: 15px; font-weight: bold; min-height: 20px; 
    }
    #adminProductManagementFeedback.correct, #adminUserManagementFeedback.correct { color: var(--cor-sucesso); }
    #adminProductManagementFeedback.error, #adminUserManagementFeedback.error { color: var(--cor-erro); }
    #adminProductManagementFeedback.warning, #adminUserManagementFeedback.warning { color: var(--cor-aviso); }


    .admin-username { color: var(--cor-admin-username); font-weight: bold; }
    .cooperator-username { color: var(--cor-cooperator-username); font-weight: bold; }

    #sidebar #loginRegisterSidebarButton {
        color: var(--cor-sidebar-texto); border-bottom: 1px solid var(--cor-sidebar-texto) !important; opacity: 0.9;
    }
    #sidebar #loginRegisterSidebarButton:hover { opacity: 1; background-color: var(--cor-sidebar-link-hover-fundo); }
    #sidebar #logoutButton {
        color: #FFEBEE; border-color: #FFEBEE !important; opacity: 0.9;
    }
    #sidebar #logoutButton:hover { opacity: 1; background-color: var(--cor-sidebar-link-hover-fundo); color: #FFCDD2; border-color: #FFCDD2 !important; }

    #gamesHubSection h2 { text-align: center; }
    #gamesHubSection p { text-align: center; margin-bottom: 25px; font-size: 1.1rem; }
    #games-hub-options { display: flex; flex-direction: column; gap: 15px; }
    #games-hub-options button {
        padding: 15px 20px; font-size: 1.3rem;
        background-color: var(--cor-botao-primario-fundo);
        color: var(--cor-botao-primario-texto);
    }
     #games-hub-options button:hover { background-color: var(--cor-botao-primario-hover); }

    #flashcardGameSection h2 { text-align: center; }
    #flashcard-container {
        perspective: 1000px; 
        margin: 20px auto;
        width: 100%;
        max-width: 400px;
        height: 250px;
    }
    #flashcard {
        width: 100%; height: 100%;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s;
        border: 2px solid var(--cor-borda-geral);
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(74, 59, 49, 0.15);
    }
    #flashcard.flipped { transform: rotateY(180deg); }
    #flashcard-front, #flashcard-back {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; 
        display: flex; align-items: center; justify-content: center;
        padding: 20px; box-sizing: border-box;
        font-size: 1.5rem; text-align: center;
        border-radius: 8px; 
        background-color: var(--cor-fundo-secundario);
        color: var(--cor-texto-principal);
    }
    #flashcard-back { transform: rotateY(180deg); background-color: #EFEBE4; }
    #flashcard-front p, #flashcard-back p { margin: 0; }
    #flashcard-front .card-label, #flashcard-back .card-label {
        font-size: 0.9rem; color: var(--cor-texto-secundario);
        position: absolute; top: 10px; left: 15px;
    }
    #flashcard-front .card-content, #flashcard-back .card-content {
        font-weight: bold;
    }

    #flip-card-button { margin-top: 15px; width: auto; padding: 10px 20px; display: block; margin-left: auto; margin-right: auto; }
    #flashcard-controls { margin-top: 25px; text-align: center; }
    #flashcard-controls p { margin-bottom: 10px; font-weight: 500; }
    .difficulty-btn-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;}
    .difficulty-btn {
        padding: 8px 15px; font-size: 0.95rem; width: auto;
        background-color: var(--cor-botao-secundario-fundo);
        color: var(--cor-botao-secundario-texto);
        border: 1px solid var(--cor-botao-secundario-borda);
    }
    .difficulty-btn:hover { background-color: var(--cor-botao-secundario-hover); }
    .difficulty-btn.selected {
        background-color: var(--cor-destaque);
        color: var(--cor-fundo-principal);
        border-color: var(--cor-destaque);
        font-weight: bold;
    }
    #flashcard-controls button.facil.selected { background-color: var(--cor-sucesso); color: white; border-color: var(--cor-sucesso); }
    #flashcard-controls button.medio.selected { background-color: var(--cor-aviso); color: var(--cor-texto-principal); border-color: var(--cor-aviso); }
    #flashcard-controls button.dificil.selected { background-color: var(--cor-erro); color: white; border-color: var(--cor-erro); }

    #next-flashcard-button { margin-top: 10px; width: auto; padding: 10px 25px; display: block; margin-left: auto; margin-right: auto; }
    #restart-flashcard-button {
        margin-top: 15px; width: auto; padding: 8px 15px; font-size: 0.9rem;
        background-color: var(--cor-botao-secundario-fundo); color: var(--cor-texto-secundario);
        border: 1px solid var(--cor-borda-geral); display: block; margin-left: auto; margin-right: auto;
    }
    #restart-flashcard-button:hover { background-color: var(--cor-botao-secundario-hover); }
    #flashcard-feedback { margin-top: 15px; text-align: center; font-weight: bold; min-height: 20px; }
    #flashcard-feedback.correct { color: var(--cor-sucesso); }
    #flashcard-feedback.error { color: var(--cor-erro); } 
    #flashcard-feedback.info { color: var(--cor-texto-secundario); }

    .back-to-games-hub-button {
        display: block; margin: 25px auto 0 auto; width: auto;
        padding: 10px 20px; background-color: var(--cor-botao-secundario-fundo);
        color: var(--cor-botao-secundario-texto); border: 1px solid var(--cor-botao-secundario-borda);
    }
    .back-to-games-hub-button:hover { background-color: var(--cor-botao-secundario-hover); }

    #instructionsSection h2 { text-align: center; }
    #instructionsContentContainer {
        text-align: left; padding: 15px; border: 1px solid var(--cor-borda-geral);
        border-radius: 6px; background-color: var(--cor-fundo-principal); margin-top: 0;
    }
    #instructionsContentContainer h4 {
        color: var(--cor-botao-primario-fundo); margin-top: 15px; margin-bottom: 10px; font-size: 1.15rem;
    }
    #instructionsContentContainer ul { list-style-type: none; padding-left: 15px; }
    #instructionsContentContainer ul li { margin-bottom: 8px; }
    #instructionsContentContainer ul ul { padding-left: 20px; list-style-type: disc; }
    #instructionsContentContainer ul ul li { margin-bottom: 5px; }
    #instructionsContentContainer p { margin-bottom: 10px; }
    #instructionsContentContainer p:last-child { margin-bottom: 0; }

  </style>
</head>
<body>
  <div id="authModalOverlay">
    <div id="authModal">
      <span id="closeAuthModal" class="close-modal-button">&times;</span>
      <h2 id="authModalTitle">Bem-vindo, Mestre Açougueiro!</h2>
      <p id="authPrompt">Faça login ou crie uma conta para prosseguir:</p>
      <input type="text" id="usernameInput" placeholder="Seu Nome de Usuário" autocomplete="off" />
      <input type="password" id="passwordInput" placeholder="Sua Senha" autocomplete="current-password" />
      <div id="authError"></div>
      <button id="authSubmit">Entrar</button>
      <button id="registerButton">Criar Conta</button>
      </div>
  </div>

  <header>
    <div id="hamburger" aria-label="Menu" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <h1 id="butcherCodeTitle" role="button" tabindex="0">ButcherCode</h1>
    <div style="width: 35px;"></div> 
  </header>

  <nav id="sidebar" aria-label="Menu lateral">
    <ul class="menu-sections">
      <li class="menu-section">
        <h2 tabindex="0" data-target="bovinosList" data-type="accordion">Códigos Bovinos</h2>
        <ul class="subfolder" id="bovinosList"></ul>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="suinosList" data-type="accordion">Códigos Suínos</h2>
        <ul class="subfolder" id="suinosList"></ul>
      </li>
      <li class="menu-section" id="loginRegisterSidebarItem" style="display:none;">
        <h2 tabindex="0" id="loginRegisterSidebarButton">Login / Criar Conta</h2>
      </li>
      <li class="menu-section">
        <h2 tabindex="0" data-target="commentsSection" data-type="main-content">Comentários e Feedback</h2>
      </li>
       <li class="menu-section" id="userProfileMenuItem" style="display:none;">
        <h2 tabindex="0" data-target="userProfileSection" data-type="main-content">Meu Perfil</h2>
      </li>
      <li class="menu-section" id="logoutSection" style="display:none;">
        <h2 tabindex="0" id="logoutButton">Sair (Logout)</h2>
      </li>
    </ul>
  </nav>

  <main class="show-initial">
    <section id="initialScreen" style="text-align: center; padding-top: 50px;">
        <div id="welcomeMessage"></div>
        <div id="loginRegisterInitialScreen" style="display:none; margin-top: 25px; margin-bottom: 25px;">
            <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; font-size: 1.1rem;">
                <a href="#" id="loginInitialLink" style="color: var(--cor-link-padrao); text-decoration: underline; padding: 8px 0;">Fazer Login</a>
                <span style="color: var(--cor-texto-secundario); margin: 0 5px;">ou</span>
                <a href="#" id="registerInitialLink" style="color: var(--cor-link-padrao); text-decoration: underline; padding: 8px 0;">Criar Conta</a>
            </div>
        </div>
        <div id="initial-screen-options">
            <button id="accessTerminalButton">Acessar Terminal</button>
            <button id="accessGamesButton">Central de Jogos</button>
            <button id="viewCommentsButton">Ver Comentários</button>
            <button id="accessInstructionsButton">Ver Instruções</button>
        </div>
    </section>

    <section id="mainTerminalSection">
        <label for="inputCode">Terminal ButcherCode</label>
        <div class="input-wrapper">
            <input type="text" id="inputCode" placeholder="Digite código ou produto aqui..." autocomplete="off" />
        </div>
        <button id="btnExecute">Executar</button>
        <div id="result" aria-live="polite" role="status"></div>
        <button class="back-to-home-button" id="backToHomeTerminal">Voltar ao Início</button>
    </section>

    <section id="addProductSection">
        <h2>Adicionar Novo Produto</h2>
        <div class="input-wrapper">
            <label for="inputNewCode">Código (máximo 5 dígitos):</label>
            <input type="number" id="inputNewCode" placeholder="Ex: 00123" min="0" max="99999" />
        </div>
        <div class="input-wrapper">
            <label for="inputNewName">Nome do Produto:</label>
            <input type="text" id="inputNewName" placeholder="Ex: Filé Mignon" />
        </div>
        <div class="input-wrapper">
            <label for="selectNewCategory">Categoria:</label>
            <select id="selectNewCategory">
                <option value="bovinos">Bovinos</option>
                <option value="suinos">Suínos</option>
            </select>
        </div>
        <button id="btnAddNewProduct">Adicionar Produto</button>
        <div id="addProductFeedback" style="margin-top: 15px; font-weight: bold; min-height: 20px;"></div>
        <button class="back-to-home-button" id="backToHomeAddProduct">Voltar ao Início</button>
    </section>

    <section id="commentsSection">
        <h2>Comentários e Feedback</h2>
        <div class="input-wrapper">
            <label for="commentInput" id="commentLabel">Escreva seu comentário:</label>
            <textarea id="commentInput" placeholder="Digite seu feedback, dicas ou sugestões aqui..."></textarea>
        </div>
        <button id="submitCommentButton">Enviar Comentário</button>
        <p id="loginToCommentMessage" style="display:none; text-align:center; margin-bottom:15px;"></p>
        <div id="commentsFeedback"></div>
        <div id="commentsList">
            <p style="text-align: center; color: var(--cor-texto-secundario);">Carregando comentários...</p>
        </div>
        <button class="back-to-home-button" id="backToHomeComments">Voltar ao Início</button>
    </section>

    <section id="userProfileSection">
        <h2>Meu Perfil</h2>
        <p>Olá, <span id="usernameDisplay">Carregando nome...</span>!</p>
        <p>Identificador de conta: <span id="userEmailDisplay">Carregando ID...</span></p>
        <p id="adminStatusText" style="display: none;">Você é um Administrador.</p>
        <p id="cooperatorStatusText" style="display: none;">Você é um Cooperador.</p>

        <button id="editUsernameButton" class="profile-action-button">Alterar Nome</button>
        <input type="text" id="newUsernameInput" placeholder="Novo nome de usuário" style="display:none; margin-top: 10px; margin-bottom:10px;" />
        <button id="saveUsernameButton" class="profile-action-button" style="display:none; margin-top: 5px;">Salvar Nome</button>
        <div id="usernameUpdateFeedback" style="margin-top: 10px; font-weight: bold; min-height:20px;"></div>

        <div id="profileActions" style="margin-top: 25px; border-top: 1px solid var(--cor-borda-geral); padding-top: 20px;">
            <button id="showAddProductFromProfileButton" class="profile-action-button" style="display:none;">Adicionar Produto</button>
            <button id="showAdminManageProductsFromProfileButton" class="profile-action-button" style="display:none;">Gerenciar Produtos</button>
            <button id="showAdminManageUsersFromProfileButton" class="profile-action-button" style="display:none;">Gerenciar Usuários</button> <!-- Novo Botão -->
        </div>
        <button class="back-to-home-button" id="backToHomeProfile" style="margin-top: 25px;">Voltar ao Início</button>
    </section>

    <section id="adminProductManagementSection">
        <h2>Gerenciar Produtos (Admin)</h2>
        <p style="color: var(--cor-aviso); margin-bottom: 15px;">Atenção: As exclusões de produtos são permanentes. Os códigos não podem ser alterados durante a edição.</p>
        <div id="adminProductManagementFeedback" style="margin-bottom:15px;"></div>
        <h3>Bovinos</h3>
        <ul id="adminBovinosList" class="product-list-admin"><li>Carregando...</li></ul>
        <h3 style="margin-top: 20px;">Suínos</h3>
        <ul id="adminSuinosList" class="product-list-admin"><li>Carregando...</li></ul>
        <button class="back-to-home-button" id="backToHomeAdminProducts">Voltar ao Início</button>
    </section>

    <!-- Nova Seção para Gerenciamento de Usuários -->
    <section id="adminUserManagementSection">
        <h2>Gerenciar Usuários (Admin)</h2>
        <p style="color: var(--cor-aviso); margin-bottom: 15px;">Atenção: Excluir um usuário aqui remove seus dados da aplicação (nome, papel), mas não apaga a conta de login do Firebase Auth. Para exclusão completa da conta, use o console do Firebase.</p>
        <div id="adminUserManagementFeedback" style="margin-bottom:15px;"></div>
        <ul id="adminUserList" class="user-list-admin"><li>Carregando usuários...</li></ul>
        <button class="profile-action-button" id="backToProfileFromUserAdmin" style="margin-top: 25px; width:100%;">Voltar ao Perfil</button>
    </section>


    <section id="gamesHubSection">
        <h2>Central de Jogos</h2>
        <p>Escolha um jogo abaixo para testar seus conhecimentos!</p>
        <div id="games-hub-options">
            <button id="playGameCodeFromHubButton">GameCode Clássico</button>
            <button id="playFlashcardGameButton">Mestre dos Códigos (Flashcards)</button>
        </div>
        <button class="back-to-home-button" id="backToHomeFromGamesHub">Voltar ao Início</button>
    </section>

    <section id="gameCodeSection"> 
        <div id="game-container">
            <div id="game-start-screen">
              <h3>Bem-vindo ao GameCode!</h3>
              <p>Teste seus conhecimentos sobre os códigos de açougue.</p>
              <p>Você terá 15 segundos para responder a cada uma das 20 perguntas.</p>
              <button id="start-game-button">Iniciar Jogo</button>
            </div>
            <div id="game-elements" style="display: none;">
              <div id="question-counter"></div>
              <div id="progress-bar-container"><div id="progress-bar"></div></div>
              <div id="timer"></div>
              <div id="question"></div>
              <div id="options"></div>
              <div id="feedback"></div>
              <div id="score-display"></div>
              <button id="next-question">Próxima Pergunta</button>
              <button id="end-game-button">Finalizar Jogo</button>
            </div>
            <div id="game-end-screen" style="display: none;">
              <h3>Jogo Finalizado!</h3>
              <p id="final-score-message"></p>
              <button id="restart-game-button">Reiniciar Jogo</button>
            </div>
        </div>
        <button class="back-to-games-hub-button" id="backToGamesHubFromGameCode">Voltar à Central de Jogos</button>
    </section>

    <section id="flashcardGameSection"> 
        <h2>Mestre dos Códigos</h2>
        <div id="flashcard-container">
            <div id="flashcard">
                <div id="flashcard-front">
                    <span class="card-label" id="flashcard-front-label"></span>
                    <p class="card-content" id="flashcard-front-content">Carregando card...</p>
                </div>
                <div id="flashcard-back">
                    <span class="card-label" id="flashcard-back-label"></span>
                    <p class="card-content" id="flashcard-back-content"></p>
                </div>
            </div>
        </div>
        <button id="flip-card-button">Virar Card</button>
        
        <div id="flashcard-controls" style="display:none;">
            <p>Como você classificaria este card?</p>
            <div class="difficulty-btn-group">
                <button class="difficulty-btn" data-difficulty="facil">Fácil</button>
                <button class="difficulty-btn" data-difficulty="medio">Médio</button>
                <button class="difficulty-btn" data-difficulty="dificil">Difícil</button>
            </div>
        </div>
        <button id="next-flashcard-button" style="display:none;">Próximo Card</button>
        <div id="flashcard-feedback"></div>
        <button id="restart-flashcard-button">Reiniciar Progresso dos Cards</button>
        <button class="back-to-games-hub-button" id="backToGamesHubFromFlashcard">Voltar à Central de Jogos</button>
    </section>

    <section id="instructionsSection">
        <h2>Instruções do ButcherCode</h2>
        <div id="instructionsContentContainer">
            <h4>Como Usar o ButcherCode:</h4>
            <p>Bem-vindo! Aqui você encontra uma ferramenta completa para códigos de produtos de açougue.</p>
            <ul>
                <li><strong>Navegação:</strong>
                    <ul>
                        <li>Utilize o menu lateral (ícone de hambúrguer <i class="fas fa-bars"></i> no canto superior esquerdo) para acessar as listas de códigos e outras seções.</li>
                        <li>Use os botões na tela inicial para acessar o "Terminal de Consulta", a "Central de Jogos" e os "Comentários".</li>
                    </ul>
                </li>
                <li><strong>Consultar Códigos/Produtos (Terminal):</strong>
                    <ul>
                        <li>Acesse "Acessar Terminal" pela tela inicial.</li>
                        <li>Digite um código (ex: "14601") para ver o nome do produto.</li>
                        <li>Digite o nome de um produto (ex: "Acém") para ver o código.</li>
                        <li>Você também pode navegar pelas listas de "Códigos Bovinos" e "Códigos Suínos" no menu lateral para ver os itens e clicar para auto-preencher no terminal.</li>
                    </ul>
                </li>
                <li><strong>Central de Jogos:</strong>
                    <ul>
                        <li>Acesse "Central de Jogos" pela tela inicial.</li>
                        <li><strong>GameCode Clássico:</strong> Teste seus conhecimentos sobre os códigos! Responda às perguntas antes que o tempo acabe.</li>
                        <li><strong>Mestre dos Códigos (Flashcards):</strong> Estude os códigos e produtos no formato de flashcards. Classifique sua dificuldade para focar no aprendizado.</li>
                    </ul>
                </li>
                <li><strong>Comentários e Feedback:</strong>
                    <ul>
                        <li>Acesse "Ver Comentários" no menu lateral ou pela tela inicial.</li>
                        <li>Veja o que outros usuários estão dizendo.</li>
                        <li>Para postar seu próprio comentário, você precisa estar logado.</li>
                    </ul>
                </li>
                <li><strong>Meu Perfil (Logado):</strong>
                    <ul>
                        <li>Acesse "Meu Perfil" no menu lateral após o login.</li>
                        <li>Visualize seu nome de usuário e identificador de conta.</li>
                        <li>Você pode alterar seu nome de usuário.</li>
                        <li>Cooperadores e Administradores encontrarão aqui opções para adicionar e gerenciar produtos.</li>
                        <li>Administradores também podem gerenciar usuários.</li>
                    </ul>
                </li>
            </ul>

            <h4>Tipos de Usuário e Permissões:</h4>
            <p>O ButcherCode possui diferentes níveis de acesso:</p>
            <ul>
                <li>
                    <strong>🥩 Usuário Comum:</strong>
                    <ul>
                        <li>Consultar códigos e nomes de produtos.</li>
                        <li>Jogar os jogos da Central de Jogos.</li>
                        <li>Visualizar comentários e instruções.</li>
                        <li>Após o login: Postar comentários e gerenciar o próprio perfil (alterar nome de usuário).</li>
                    </ul>
                </li>
                <li>
                    <strong>🔪 Cooperador (Nome destacado em <span class="cooperator-username">cor especial</span>):</strong>
                    <ul>
                        <li>Todas as permissões de um Usuário Comum.</li>
                        <li>Após o login (via "Meu Perfil"): Adicionar novos produtos (código, nome e categoria).</li>
                        <li>Seu nome terá um destaque especial nos comentários e na mensagem de boas-vindas.</li>
                    </ul>
                </li>
                <li>
                    <strong>👑 Administrador (Nome destacado em <span class="admin-username">cor especial</span>):</strong>
                    <ul>
                        <li>Todas as permissões de um Cooperador.</li>
                        <li>Após o login (via "Meu Perfil"):
                            <ul>
                                <li>Acessar "Gerenciar Produtos" para editar (nome, categoria) e excluir produtos existentes.</li>
                                <li>Acessar "Gerenciar Usuários" para listar e excluir dados de usuários da aplicação.</li>
                            </ul>
                        </li>
                        <li>Excluir comentários de qualquer usuário na seção de "Comentários e Feedback".</li>
                        <li>Seu nome terá um destaque especial nos comentários e em outras áreas.</li>
                    </ul>
                </li>
            </ul>
            <p>Use o sistema com responsabilidade. Em caso de dúvidas ou problemas, deixe um feedback!</p>
        </div>
        <button class="back-to-home-button" id="backToHomeFromInstructions">Voltar ao Início</button>
    </section>

  </main>

<script type="module">
  // Firebase e imports permanecem os mesmos
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, updateDoc, setDoc, serverTimestamp, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCenbkggBbZmkc8ULS--1iL0KIsm4Flmpk", // ATENÇÃO: SUBSTITUA PELA SUA CHAVE REAL E PROTEJA-A!
    authDomain: "butchercode-4e998.firebaseapp.com",
    projectId: "butchercode-4e998",
    storageBucket: "butchercode-4e998.firebasestorage.app",
    messagingSenderId: "535961032533",
    appId: "1:535961032533:web:de1ad79b53c18f125d01dc"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  document.addEventListener('DOMContentLoaded', () => {
    // --- Seletores de Elementos DOM ---
    const authModalOverlay = document.getElementById('authModalOverlay');
    const authModalTitle = document.getElementById('authModalTitle');
    const authPrompt = document.getElementById('authPrompt');
    const passwordInput = document.getElementById('passwordInput');
    const usernameInputDOM = document.getElementById('usernameInput');
    const authSubmit = document.getElementById('authSubmit');
    const registerButton = document.getElementById('registerButton');
    const authError = document.getElementById('authError');
    const closeAuthModalButton = document.getElementById('closeAuthModal');

    const welcomeMessage = document.getElementById('welcomeMessage');
    const initialScreenOptions = document.getElementById('initial-screen-options');
    const butcherCodeTitle = document.getElementById('butcherCodeTitle');
    const logoutSection = document.getElementById('logoutSection');
    const logoutButton = document.getElementById('logoutButton');
    const userProfileMenuItem = document.getElementById('userProfileMenuItem');

    const loginRegisterSidebarItem = document.getElementById('loginRegisterSidebarItem');
    const loginRegisterSidebarButton = document.getElementById('loginRegisterSidebarButton');
    const loginRegisterInitialScreen = document.getElementById('loginRegisterInitialScreen');
    const loginInitialLink = document.getElementById('loginInitialLink');
    const registerInitialLink = document.getElementById('registerInitialLink');

    const userProfileSection = document.getElementById('userProfileSection');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const editUsernameButton = document.getElementById('editUsernameButton');
    const newUsernameInput = document.getElementById('newUsernameInput');
    const saveUsernameButton = document.getElementById('saveUsernameButton');
    const usernameUpdateFeedback = document.getElementById('usernameUpdateFeedback');
    const adminStatusText = document.getElementById('adminStatusText');
    const cooperatorStatusText = document.getElementById('cooperatorStatusText');
    const showAddProductFromProfileButton = document.getElementById('showAddProductFromProfileButton');
    const showAdminManageProductsFromProfileButton = document.getElementById('showAdminManageProductsFromProfileButton');
    const showAdminManageUsersFromProfileButton = document.getElementById('showAdminManageUsersFromProfileButton'); // Novo

    const mainTerminalSection = document.getElementById('mainTerminalSection');
    const inputCode = document.getElementById('inputCode');
    const btnExecute = document.getElementById('btnExecute');
    const resultDiv = document.getElementById('result');
    const bovinosList = document.getElementById('bovinosList');
    const suinosList = document.getElementById('suinosList');

    const addProductSectionDOM = document.getElementById('addProductSection');
    const inputNewCode = document.getElementById('inputNewCode');
    const inputNewName = document.getElementById('inputNewName');
    const selectNewCategory = document.getElementById('selectNewCategory');
    const btnAddNewProduct = document.getElementById('btnAddNewProduct');
    const addProductFeedback = document.getElementById('addProductFeedback');
    const backToHomeAddProductButton = document.getElementById('backToHomeAddProduct');
    const addProductSectionTitle = document.querySelector('#addProductSection h2');

    const commentsSectionDOM = document.getElementById('commentsSection');
    const commentLabel = document.getElementById('commentLabel');
    const commentInput = document.getElementById('commentInput');
    const submitCommentButton = document.getElementById('submitCommentButton');
    const commentsFeedback = document.getElementById('commentsFeedback');
    const commentsList = document.getElementById('commentsList');
    const loginToCommentMessage = document.getElementById('loginToCommentMessage');
    const backToHomeCommentsButton = document.getElementById('backToHomeComments');

    const mainContent = document.querySelector('main');
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const sidebarTitles = document.querySelectorAll('#sidebar h2[data-type="accordion"]');
    const initialScreen = document.getElementById('initialScreen');

    const accessTerminalButton = document.getElementById('accessTerminalButton');
    const accessGamesButton = document.getElementById('accessGamesButton'); 
    const viewCommentsButton = document.getElementById('viewCommentsButton');
    const accessInstructionsButton = document.getElementById('accessInstructionsButton'); 

    const gamesHubSection = document.getElementById('gamesHubSection');
    const playGameCodeFromHubButton = document.getElementById('playGameCodeFromHubButton');
    const playFlashcardGameButton = document.getElementById('playFlashcardGameButton');
    const backToHomeFromGamesHubButton = document.getElementById('backToHomeFromGamesHub');

    const instructionsSection = document.getElementById('instructionsSection');
    const backToHomeFromInstructionsButton = document.getElementById('backToHomeFromInstructions');
    
    const gameCodeSection = document.getElementById('gameCodeSection'); 
    const backToGamesHubFromGameCodeButton = document.getElementById('backToGamesHubFromGameCode');

    const flashcardGameSection = document.getElementById('flashcardGameSection');
    const flashcardDiv = document.getElementById('flashcard');
    const flashcardFrontLabel = document.getElementById('flashcard-front-label');
    const flashcardFrontContent = document.getElementById('flashcard-front-content');
    const flashcardBackLabel = document.getElementById('flashcard-back-label');
    const flashcardBackContent = document.getElementById('flashcard-back-content');
    const flipCardButton = document.getElementById('flip-card-button');
    const flashcardControlsDiv = document.getElementById('flashcard-controls');
    const difficultyButtons = document.querySelectorAll('.difficulty-btn');
    const nextFlashcardButton = document.getElementById('next-flashcard-button');
    const restartFlashcardButton = document.getElementById('restart-flashcard-button');
    const flashcardFeedbackDiv = document.getElementById('flashcard-feedback');
    const backToGamesHubFromFlashcardButton = document.getElementById('backToGamesHubFromFlashcard');

    const backToHomeTerminalButton = document.getElementById('backToHomeTerminal');
    const backToHomeProfileButton = document.getElementById('backToHomeProfile');

    const gameStartScreen = document.getElementById('game-start-screen');
    const gameEndScreen = document.getElementById('game-end-screen');
    const gameElements = document.getElementById('game-elements');
    const startGameButton = document.getElementById('start-game-button');
    const restartGameButton = document.getElementById('restart-game-button');
    const questionElement = document.getElementById('question');
    const optionsElement = document.getElementById('options');
    const feedbackElement = document.getElementById('feedback');
    const scoreDisplayElement = document.getElementById('score-display');
    const nextQuestionButton = document.getElementById('next-question');
    const progressBar = document.getElementById('progress-bar');
    const timerElement = document.getElementById('timer');
    const questionCounterElement = document.getElementById('question-counter');
    const finalScoreMessage = document.getElementById('final-score-message');
    const endGameButton = document.getElementById('end-game-button');

    const adminProductManagementSection = document.getElementById('adminProductManagementSection');
    const adminBovinosList = document.getElementById('adminBovinosList');
    const adminSuinosList = document.getElementById('adminSuinosList');
    const adminProductManagementFeedback = document.getElementById('adminProductManagementFeedback');
    const backToHomeAdminProductsButton = document.getElementById('backToHomeAdminProducts');

    // Novos seletores para Gerenciamento de Usuários
    const adminUserManagementSection = document.getElementById('adminUserManagementSection');
    const adminUserList = document.getElementById('adminUserList');
    const adminUserManagementFeedback = document.getElementById('adminUserManagementFeedback');
    const backToProfileFromUserAdminButton = document.getElementById('backToProfileFromUserAdmin');


    // --- Variáveis Globais e Estado ---
    let currentUser = null;
    let currentUserRole = 'user';
    let activeAccordionItem = null;
    const PANTRY_ID = '4f7072cc-f2b3-4852-a675-8fa440048289'; 
    const BASKET_NAME = 'butcher_products';
    let productData = { bovinos: {}, suinos: {}, meta: { version: 1, last_updated: "" } };
    let productsInverseNormalized = {};
    
    const GAME_CODE_STATE_KEY = "game_code_state";
    const TIME_PER_QUESTION = 15;
    let gameCodeTimeLeft, gameCodeTimerInterval, gameCodeTickSoundInterval;
    let gameCodeCurrentQuestionIndex = 0, gameCodeScore = 0, gameCodeQuestions = [];

    const FLASHCARD_DIFFICULTY_KEY = "butchercode_flashcard_difficulties";
    let flashcardDifficulties = {}; 
    let currentFlashcard = null; 
    let allFlashcardProducts = [];


    const sounds = {
        correct: new Audio('images/sounds/correct.mp3'),
        incorrect: new Audio('images/sounds/incorrect.mp3'),
        gameStart: new Audio('images/sounds/game-start.mp3'),
        gameEnd: new Audio('images/sounds/game-end.mp3'),
        tick: new Audio('images/sounds/tick.mp3'),
        terminalSuccess: new Audio('images/sounds/terminal-success.mp3'),
        terminalError: new Audio('images/sounds/terminal-error.mp3'),
        flip: new Audio('images/sounds/flip.mp3') 
    };

    // --- Funções Utilitárias ---
    function playSound(soundName) {
        if (sounds[soundName]) {
            sounds[soundName].currentTime = 0;
            sounds[soundName].play().catch(e => console.warn("Erro ao tocar som:", soundName, e));
        }
    }

    function normalizeText(text) {
        return text
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, '')
            .trim();
    }

    function generateFakeEmail(username) {
        return `${normalizeText(username).replace(/[^a-z0-9]/g, '')}@butchercode.com`;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // --- Lógica de UI e Navegação ---
    function updateUserAccessUI() {
        const isAdmin = currentUserRole === 'admin';
        const isCooperator = currentUserRole === 'cooperator';
        const isLoggedIn = !!currentUser;

        if (loginRegisterSidebarItem) loginRegisterSidebarItem.style.display = isLoggedIn ? 'none' : 'block';
        if (loginRegisterInitialScreen) loginRegisterInitialScreen.style.display = isLoggedIn ? 'none' : 'block';

        if (userProfileMenuItem) userProfileMenuItem.style.display = isLoggedIn ? 'block' : 'none';
        if (logoutSection) logoutSection.style.display = isLoggedIn ? 'block' : 'none';

        if (showAddProductFromProfileButton) {
            showAddProductFromProfileButton.style.display = isLoggedIn && (isAdmin || isCooperator) ? 'inline-block' : 'none';
        }
        if (showAdminManageProductsFromProfileButton) {
            showAdminManageProductsFromProfileButton.style.display = isLoggedIn && isAdmin ? 'inline-block' : 'none';
        }
        if (showAdminManageUsersFromProfileButton) { // Novo botão
            showAdminManageUsersFromProfileButton.style.display = isLoggedIn && isAdmin ? 'inline-block' : 'none';
        }
        if(adminStatusText) adminStatusText.style.display = isLoggedIn && isAdmin ? 'block' : 'none';
        if(cooperatorStatusText) cooperatorStatusText.style.display = isLoggedIn && isCooperator && !isAdmin ? 'block' : 'none';


        if (mainContent.classList.contains('show-comments')) {
            loadComments();
        }
        if (mainContent.classList.contains('show-admin-products') && !isAdmin) {
            showSection('initialScreen');
        }
         if (mainContent.classList.contains('show-admin-users') && !isAdmin) { // Novo
            showSection('initialScreen');
        }
        const addProductSectionEl = document.getElementById('addProductSection');
        const editingCode = addProductSectionEl ? addProductSectionEl.dataset.editingCode : null;

        if (mainContent.classList.contains('show-add-product')) {
            if (editingCode && !isAdmin) {
                showSection('initialScreen');
            } else if (!editingCode && (!isLoggedIn || (!isAdmin && !isCooperator))) {
                 showSection('initialScreen');
            }
        }
    }

    function showSection(sectionId, fromSubSection = false) {
        mainContent.classList.remove('show-terminal', 'show-game', 'show-initial', 
                                    'show-add-product', 'show-comments', 'show-profile', 
                                    'show-admin-products', 'show-admin-users', 'show-games-hub', 
                                    'show-flashcard-game', 'show-instructions');
        document.querySelectorAll('.back-to-home-button, .back-to-games-hub-button, #backToProfileFromUserAdmin').forEach(btn => {
            if(btn) btn.style.display = 'none';
        });


        if (sectionId !== 'gameCodeSection') {
            clearInterval(gameCodeTimerInterval); clearInterval(gameCodeTickSoundInterval);
        }
        
        let targetButtonToDisplay = null;

        if (sectionId === 'mainTerminalSection') {
            mainContent.classList.add('show-terminal');
            targetButtonToDisplay = backToHomeTerminalButton;
        } else if (sectionId === 'gamesHubSection') {
            mainContent.classList.add('show-games-hub');
            targetButtonToDisplay = backToHomeFromGamesHubButton;
        } else if (sectionId === 'gameCodeSection') {
            mainContent.classList.add('show-game');
            if(gameStartScreen) gameStartScreen.style.display = 'flex';
            if(gameElements) gameElements.style.display = 'none';
            if(gameEndScreen) gameEndScreen.style.display = 'none';
            targetButtonToDisplay = backToGamesHubFromGameCodeButton;
        } else if (sectionId === 'flashcardGameSection') {
            mainContent.classList.add('show-flashcard-game');
            startFlashcardGame(); 
            targetButtonToDisplay = backToGamesHubFromFlashcardButton;
        } else if (sectionId === 'instructionsSection') {
            mainContent.classList.add('show-instructions');
            targetButtonToDisplay = backToHomeFromInstructionsButton;
        } else if (sectionId === 'addProductSection') {
            const isAdmin = currentUserRole === 'admin';
            const isCooperator = currentUserRole === 'cooperator';
            const canAccessAddProduct = isAdmin || isCooperator;

            if (!currentUser) {
                showAuthModal('Você precisa fazer login para acessar esta funcionalidade.');
                return;
            }
            const addProductSectionEl = document.getElementById('addProductSection');
            const isEditing = addProductSectionEl && addProductSectionEl.dataset.editingCode;

            if (!isEditing && !canAccessAddProduct) {
                showAuthModal('Você não tem permissão para adicionar produtos.', 'Acesso Negado');
                setTimeout(() => showSection('initialScreen'), 0);
                return;
            }
            if (isEditing && !isAdmin) { 
                 showAuthModal('Apenas administradores podem editar produtos.', 'Acesso Negado');
                setTimeout(() => showSection('initialScreen'), 0);
                return;
            }
            mainContent.classList.add('show-add-product');
            targetButtonToDisplay = backToHomeAddProductButton;
            if (!isEditing) { 
                resetAddProductForm();
            }
        } else if (sectionId === 'commentsSection') {
            mainContent.classList.add('show-comments');
            loadComments();
            targetButtonToDisplay = backToHomeCommentsButton;
             if (currentUser) {
                if(commentLabel) commentLabel.style.display = 'block';
                if(commentInput) { commentInput.style.display = 'block'; commentInput.disabled = false; }
                if(submitCommentButton) { submitCommentButton.style.display = 'block'; submitCommentButton.disabled = false; }
                if(loginToCommentMessage) loginToCommentMessage.style.display = 'none';
            } else {
                if(commentLabel) commentLabel.style.display = 'none';
                if(commentInput) { commentInput.style.display = 'none'; commentInput.disabled = true; }
                if(submitCommentButton) { submitCommentButton.style.display = 'none'; submitCommentButton.disabled = true; }
                if(loginToCommentMessage) {
                    loginToCommentMessage.style.display = 'block';
                    loginToCommentMessage.innerHTML = `Você precisa <a href="#" id="loginLinkFromComments" style="color: var(--cor-link-padrao);">fazer login</a> para comentar.`;
                    loginToCommentMessage.classList.remove('correct', 'error', 'warning'); 
                    loginToCommentMessage.classList.add('warning'); 
                    const loginLink = document.getElementById('loginLinkFromComments');
                    if (loginLink && !loginLink.dataset.listenerAttached) {
                        loginLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            showAuthModal('Faça login para poder comentar.');
                        });
                        loginLink.dataset.listenerAttached = 'true';
                    }
                }
            }
        } else if (sectionId === 'userProfileSection') {
            if (!currentUser) {
                showAuthModal('Você precisa fazer login para ver seu perfil.');
                return;
            }
            mainContent.classList.add('show-profile');
            if (currentUser && currentUser.uid && db) {
                getDoc(doc(db, 'users', currentUser.uid)).then(docSnap => {
                    const userData = docSnap.exists() ? docSnap.data() : null;
                    const displayName = userData && userData.username ? userData.username : (currentUser.email ? currentUser.email.split('@')[0] : 'Usuário');

                    if(usernameDisplay) {
                        usernameDisplay.textContent = displayName;
                        usernameDisplay.classList.remove('admin-username', 'cooperator-username');
                        if (currentUserRole === 'admin') usernameDisplay.classList.add('admin-username');
                        else if (currentUserRole === 'cooperator') usernameDisplay.classList.add('cooperator-username');
                    }
                    if(userEmailDisplay && currentUser.email) userEmailDisplay.textContent = currentUser.email;
                    updateUserAccessUI(); // Atualiza visibilidade dos botões de admin no perfil
                }).catch(e => {
                    console.error("Erro ao carregar dados do perfil:", e);
                     const fallbackUsername = currentUser.email ? currentUser.email.split('@')[0] : 'Usuário';
                    if(usernameDisplay) {
                         usernameDisplay.textContent = fallbackUsername;
                         usernameDisplay.classList.remove('admin-username', 'cooperator-username');
                    }
                    if(userEmailDisplay && currentUser.email) userEmailDisplay.textContent = currentUser.email;
                });
            }
            targetButtonToDisplay = backToHomeProfileButton;
        } else if (sectionId === 'adminProductManagementSection') {
            if (!currentUser || currentUserRole !== 'admin') {
                showAuthModal('Acesso restrito a administradores.');
                if (currentUser && currentUserRole !== 'admin') setTimeout(() => showSection('initialScreen'),0);
                return;
            }
            mainContent.classList.add('show-admin-products');
            populateAdminProductLists();
            targetButtonToDisplay = backToHomeAdminProductsButton;
        } else if (sectionId === 'adminUserManagementSection') { // Nova seção
            if (!currentUser || currentUserRole !== 'admin') {
                showAuthModal('Acesso restrito a administradores.');
                 if (currentUser && currentUserRole !== 'admin') setTimeout(() => showSection('initialScreen'),0);
                return;
            }
            mainContent.classList.add('show-admin-users');
            populateAdminUserList();
            targetButtonToDisplay = backToProfileFromUserAdminButton;
        } else { 
            mainContent.classList.add('show-initial');
            if(welcomeMessage) welcomeMessage.classList.add('show');
            if(initialScreenOptions) initialScreenOptions.classList.add('show');
        }

        if(targetButtonToDisplay) targetButtonToDisplay.style.display = 'block';

        if (!fromSubSection) { 
            if (hamburger) hamburger.classList.remove('open');
            if (sidebar) sidebar.classList.remove('open');
            document.body.classList.remove('sidebar-open');
        }
    }


    function showAuthModal(reasonMessage = '', generalPrompt = 'Faça login ou crie uma conta para prosseguir:') {
      if(authModalTitle) authModalTitle.textContent = 'Bem-vindo, Mestre Açougueiro!';
      if (reasonMessage && authPrompt) {
          authPrompt.textContent = reasonMessage;
      } else if(authPrompt) {
          authPrompt.textContent = generalPrompt;
      }
      if(authError) authError.textContent = '';
      if(authModalOverlay) authModalOverlay.classList.add('show');

      if(authSubmit) authSubmit.textContent = 'Entrar';
      if(registerButton) registerButton.textContent = 'Criar Conta';

      if(usernameInputDOM) {
        usernameInputDOM.value = '';
      }
      if(passwordInput) passwordInput.value = '';
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                const userData = userDocSnap.exists() ? userDocSnap.data() : null;

                const displayName = userData && userData.username ? userData.username : (user.email ? user.email.split('@')[0] : 'Usuário');
                currentUserRole = userData && userData.role ? userData.role : 'user';

                let welcomeDisplayName = displayName;
                 if (currentUserRole === 'admin') {
                    welcomeDisplayName = `<span class="admin-username">${displayName} (Admin)</span>`;
                } else if (currentUserRole === 'cooperator') {
                    welcomeDisplayName = `<span class="cooperator-username">${displayName} (Cooperador)</span>`;
                }

                if(welcomeMessage) welcomeMessage.innerHTML = `Bem-vindo, ${welcomeDisplayName}! <br>Vamos aos cortes!`;

                if (mainContent.classList.contains('show-profile') && usernameDisplay) {
                    usernameDisplay.textContent = displayName;
                    usernameDisplay.classList.remove('admin-username', 'cooperator-username');
                    if (currentUserRole === 'admin') usernameDisplay.classList.add('admin-username');
                    else if (currentUserRole === 'cooperator') usernameDisplay.classList.add('cooperator-username');
                }
                if(userEmailDisplay && user.email && mainContent.classList.contains('show-profile')) userEmailDisplay.textContent = user.email;


            } catch (error) {
                console.error("Erro ao carregar dados do usuário no Firestore:", error);
                const fallbackUsername = user.email ? user.email.split('@')[0] : 'Usuário';
                if(welcomeMessage) welcomeMessage.innerHTML = `Bem-vindo, ${fallbackUsername}! <br>Vamos aos cortes!`;
                if(usernameDisplay && mainContent.classList.contains('show-profile')) {
                     usernameDisplay.textContent = fallbackUsername;
                     usernameDisplay.classList.remove('admin-username', 'cooperator-username');
                }
                if(userEmailDisplay && user.email && mainContent.classList.contains('show-profile')) userEmailDisplay.textContent = user.email;
                currentUserRole = 'user';
            }

            if(welcomeMessage) welcomeMessage.classList.add('show');
            if(initialScreenOptions) initialScreenOptions.classList.add('show');
            if(authModalOverlay) authModalOverlay.classList.remove('show');
            if(loginRegisterInitialScreen) loginRegisterInitialScreen.style.display = 'none';

        } else {
            currentUser = null;
            currentUserRole = 'user';
            if(welcomeMessage) {
              welcomeMessage.innerHTML = "Bem-vindo ao ButcherCode! <br>Sua central de códigos e informações de açougue.";
            }
            if(welcomeMessage) welcomeMessage.classList.add('show');
            if(initialScreenOptions) initialScreenOptions.classList.add('show');
            if(authModalOverlay) authModalOverlay.classList.remove('show');
            if(loginRegisterInitialScreen) loginRegisterInitialScreen.style.display = 'block';

            if(usernameDisplay && mainContent.classList.contains('show-profile')) {
                 usernameDisplay.textContent = '';
                 usernameDisplay.classList.remove('admin-username', 'cooperator-username');
            }
            if(userEmailDisplay && mainContent.classList.contains('show-profile')) userEmailDisplay.textContent = '';


            const isRestrictedSectionForGuests = mainContent.classList.contains('show-profile') ||
                                                 mainContent.classList.contains('show-add-product') ||
                                                 mainContent.classList.contains('show-admin-products') ||
                                                 mainContent.classList.contains('show-admin-users'); // Nova seção
            if (isRestrictedSectionForGuests) {
                 showSection('initialScreen');
            } else if (mainContent.classList.contains('show-comments')) {
                 showSection('commentsSection'); 
            }
        }
        updateUserAccessUI();
    });


    if (closeAuthModalButton) {
        closeAuthModalButton.addEventListener('click', () => {
            if (authModalOverlay) authModalOverlay.classList.remove('show');
        });
    }
    if (authModalOverlay) {
        authModalOverlay.addEventListener('click', (event) => {
            if (event.target === authModalOverlay) {
                authModalOverlay.classList.remove('show');
            }
        });
    }

    if(authSubmit) {
        authSubmit.addEventListener('click', async () => {
            const usernameVal = usernameInputDOM.value.trim();
            const passwordVal = passwordInput.value.trim();
            if(authError) authError.textContent = '';

            if (authSubmit.textContent === 'Voltar para Login') {
                if(authModalTitle) authModalTitle.textContent = 'Bem-vindo, Mestre Açougueiro!';
                if(authPrompt) authPrompt.textContent = 'Faça login ou crie uma conta para prosseguir:';
                authSubmit.textContent = 'Entrar';
                if(registerButton) registerButton.textContent = 'Criar Conta';
                return;
            }

            if (!usernameVal || !passwordVal) {
                if(authError) authError.textContent = 'Por favor, insira nome de usuário e senha.';
                return;
            }

            try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', usernameVal));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    if(authError) authError.textContent = 'Nome de usuário ou senha inválidos.';
                    return;
                }

                const userData = querySnapshot.docs[0].data();
                const fakeEmail = userData.email;

                if (!fakeEmail) {
                    if(authError) authError.textContent = 'Erro na conta. Por favor, contate o suporte.';
                    console.error('Usuário encontrado no Firestore sem email falso:', userData);
                    return;
                }
                await signInWithEmailAndPassword(auth, fakeEmail, passwordVal);
            } catch (error) {
                console.error("Erro ao fazer login:", error);
                let errorMessage = "Erro no login.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    errorMessage = "Nome de usuário ou senha inválidos.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Muitas tentativas de login. Tente novamente mais tarde.";
                } else {
                    errorMessage = `Erro: ${error.message}`;
                }
                if(authError) authError.textContent = errorMessage;
            }
        });
    }

    if(registerButton) {
        registerButton.addEventListener('click', async () => {
            const usernameVal = usernameInputDOM.value.trim();
            const passwordVal = passwordInput.value.trim();
            if(authError) authError.textContent = '';

            if (registerButton.textContent === 'Criar Conta') {
                if(authModalTitle) authModalTitle.textContent = 'Criar Nova Conta';
                if(authPrompt) authPrompt.textContent = 'Preencha seus dados para criar sua conta:';
                if(authSubmit) authSubmit.textContent = 'Voltar para Login';
                registerButton.textContent = 'Registrar';
            } else {
                if (!usernameVal) {
                    if(authError) authError.textContent = 'Por favor, insira um nome de usuário.';
                    return;
                }
                if (!passwordVal) {
                    if(authError) authError.textContent = 'Por favor, insira uma senha.';
                    return;
                }
                if (passwordVal.length < 6) {
                     if(authError) authError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                    return;
                }


                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', usernameVal));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    if(authError) authError.textContent = 'Este nome de usuário já está em uso.';
                    return;
                }

                try {
                    const fakeEmail = generateFakeEmail(usernameVal);
                    const userCredential = await createUserWithEmailAndPassword(auth, fakeEmail, passwordVal);
                    const user = userCredential.user;

                    await setDoc(doc(db, 'users', user.uid), {
                        username: usernameVal,
                        email: fakeEmail, // Armazena o email falso para referência
                        createdAt: serverTimestamp(),
                        role: 'user'
                    });
                } catch (error) {
                    console.error("Erro ao registrar:", error);
                    let errorMessage = "Erro no registro.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "Um erro inesperado ocorreu (o email gerado já existe). Tente outro nome de usuário.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                    } else {
                        errorMessage = `Erro: ${error.message}`;
                    }
                    if(authError) authError.textContent = errorMessage;
                }
            }
        });
    }

    if (loginRegisterSidebarButton) {
        loginRegisterSidebarButton.addEventListener('click', () => {
            showAuthModal('Faça login ou crie uma conta para continuar.');
            if (hamburger && hamburger.classList.contains('open')) {
                hamburger.classList.remove('open');
                if (sidebar) sidebar.classList.remove('open');
                document.body.classList.remove('sidebar-open');
            }
        });
    }

    if (loginInitialLink) {
        loginInitialLink.addEventListener('click', (e) => {
            e.preventDefault();
            showAuthModal('Bem-vindo de volta! Faça seu login ou crie uma conta.');
            if(authModalTitle) authModalTitle.textContent = 'Bem-vindo, Mestre Açougueiro!';
            if(authPrompt) authPrompt.textContent = 'Faça login ou crie uma conta para prosseguir:';
            if(authSubmit) authSubmit.textContent = 'Entrar';
            if(registerButton) registerButton.textContent = 'Criar Conta';
            if(passwordInput) passwordInput.value = '';
            if(authError) authError.textContent = '';
        });
    }

    if (registerInitialLink) {
        registerInitialLink.addEventListener('click', (e) => {
            e.preventDefault();
            showAuthModal('Novo por aqui? Crie sua conta ou faça login se já tiver uma.');
            if(authModalTitle) authModalTitle.textContent = 'Criar Nova Conta';
            if(authPrompt) authPrompt.textContent = 'Preencha seus dados para criar sua conta:';
            if(authSubmit) authSubmit.textContent = 'Voltar para Login';
            if(registerButton) registerButton.textContent = 'Registrar';
            if(passwordInput) passwordInput.value = '';
            if(authError) authError.textContent = '';
        });
    }


    if(logoutButton) {
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                const feedbackEl = document.getElementById('userProfileSection'); 
                if (feedbackEl) {
                    const p = document.createElement('p');
                    p.textContent = "Erro ao fazer logout.";
                    p.style.color = "var(--cor-erro)";
                    feedbackEl.prepend(p);
                    setTimeout(() => p.remove(), 3000);
                }
            }
        });
    }

    if(editUsernameButton) {
      editUsernameButton.addEventListener('click', () => {
          if(newUsernameInput) newUsernameInput.style.display = 'block';
          if(saveUsernameButton) saveUsernameButton.style.display = 'block';
          if(usernameUpdateFeedback) {
            usernameUpdateFeedback.textContent = '';
            usernameUpdateFeedback.className = '';
          }

          if (currentUser && db) {
              getDoc(doc(db, 'users', currentUser.uid)).then(docSnap => {
                  const userData = docSnap.data();
                  if(newUsernameInput) newUsernameInput.value = userData && userData.username ? userData.username : '';
              }).catch(e => console.error("Erro ao carregar nome de usuário para edição:", e));
          }
          editUsernameButton.style.display = 'none';
      });
    }

    if(saveUsernameButton) {
      saveUsernameButton.addEventListener('click', async () => {
          const newUsernameVal = newUsernameInput.value.trim();
          if(usernameUpdateFeedback) usernameUpdateFeedback.className = '';

          if (!newUsernameVal) {
              if(usernameUpdateFeedback) {
                  usernameUpdateFeedback.textContent = 'O nome de usuário não pode estar vazio.';
                  usernameUpdateFeedback.classList.add('error');
              }
              return;
          }

          if (currentUser && db) {
              try {
                  const usersRef = collection(db, 'users');
                  const q = query(usersRef, where('username', '==', newUsernameVal));
                  const querySnapshot = await getDocs(q);

                  let usernameExists = false;
                  querySnapshot.forEach(docSnap => {
                      if (docSnap.id !== currentUser.uid) {
                          usernameExists = true;
                      }
                  });

                  if (usernameExists) {
                      if(usernameUpdateFeedback) {
                          usernameUpdateFeedback.textContent = 'Este nome de usuário já está em uso por outro usuário.';
                          usernameUpdateFeedback.classList.add('error');
                      }
                      return;
                  }

                  const userDocRef = doc(db, 'users', currentUser.uid);
                  await updateDoc(userDocRef, {
                      username: newUsernameVal
                  });

                  const displayName = newUsernameVal;
                  if(usernameDisplay) {
                      usernameDisplay.textContent = displayName;
                      usernameDisplay.classList.remove('admin-username', 'cooperator-username');
                      if (currentUserRole === 'admin') usernameDisplay.classList.add('admin-username');
                      else if (currentUserRole === 'cooperator') usernameDisplay.classList.add('cooperator-username');
                  }

                  let welcomeDisplayName = displayName;
                  if (currentUserRole === 'admin') {
                      welcomeDisplayName = `<span class="admin-username">${displayName} (Admin)</span>`;
                  } else if (currentUserRole === 'cooperator') {
                      welcomeDisplayName = `<span class="cooperator-username">${displayName} (Cooperador)</span>`;
                  }
                  if(welcomeMessage) welcomeMessage.innerHTML = `Bem-vindo, ${welcomeDisplayName}! <br>Vamos aos cortes!`;


                  if(usernameUpdateFeedback) {
                      usernameUpdateFeedback.textContent = 'Nome de usuário atualizado com sucesso!';
                      usernameUpdateFeedback.classList.add('correct');
                  }
                  if(newUsernameInput) newUsernameInput.style.display = 'none';
                  if(saveUsernameButton) saveUsernameButton.style.display = 'none';
                  if(editUsernameButton) editUsernameButton.style.display = 'inline-block';
                  setTimeout(() => { if(usernameUpdateFeedback) usernameUpdateFeedback.textContent = ''; usernameUpdateFeedback.className = ''; }, 3000);
              } catch (error) {
                  console.error("Erro ao atualizar nome de usuário:", error);
                  if(usernameUpdateFeedback) {
                      usernameUpdateFeedback.textContent = `Erro ao atualizar: ${error.message}`;
                      usernameUpdateFeedback.classList.add('error');
                  }
              }
          }
      });
    }

    if(showAddProductFromProfileButton) {
        showAddProductFromProfileButton.addEventListener('click', () => showSection('addProductSection', true));
    }
    if(showAdminManageProductsFromProfileButton) {
        showAdminManageProductsFromProfileButton.addEventListener('click', () => showSection('adminProductManagementSection', true));
    }
    if(showAdminManageUsersFromProfileButton) { // Novo
        showAdminManageUsersFromProfileButton.addEventListener('click', () => showSection('adminUserManagementSection', true));
    }


    async function loadProductData() {
        try {
            const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`);
            if (!response.ok) {
                if (response.status === 404) {
                    console.warn("Pantry basket não encontrado ou vazio. Usando dados padrão e tentando criar.");
                    productData = {
                        bovinos: {"14601":"Acém","14625":"Alcatra com Maminha","1762":"Bisteca com osso","14694":"Colchão Duro","26390":"Colchão Mole"},
                        suinos: {"11549":"Bisteca Suína","18159":"Pé Suíno"},
                        meta: { version: 0, last_updated: new Date().toISOString() }
                    };
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } else {
                const data = await response.json();
                if (data && data.bovinos && data.suinos && data.meta) {
                    productData = data;
                } else {
                    console.warn("Dados do Pantry em formato inesperado. Usando dados padrão.");
                    productData = { bovinos: {}, suinos: {}, meta: { version: 0, last_updated: new Date().toISOString() } };
                }
            }
        } catch (error) {
            console.error("Erro ao carregar dados do Pantry:", error);
             productData = {
                "meta": { "version": 1, "last_updated": new Date().toISOString() },
                "bovinos": { "14601": "Acém", "14625": "Alcatra com Maminha", "1762": "Bisteca com osso", "14694": "Colchão Duro", "26390": "Colchão Mole", "25812": "Contra Filé", "14793": "Coração da Alcatra", "4282": "Fígado", "14762": "Lagarto", "14809": "Miolo da Paleta", "14618": "Músculo do Dianteiro", "14816": "Paleta", "14823": "Patinho", "00260": "Picanha em Pedaços", "05418": "Picanha Grill", "16094": "Picanha Maturada", "07160": "Picanha Todo Dia", "06019": "Picanha Tradicional" },
                "suinos": { "11549": "Bisteca Suína", "23023": "Carne Suína Corte", "15776": "Carne Suína Embalada", "23740": "Costela com Panceta Suína Corte", "23733": "Costela com Panceta Suína Embalada", "18159": "Pé Suíno" }
            };
        } finally {
             rebuildProductIndexesAndSidebar();
             prepareAllFlashcardProducts(); 
             if (mainContent.classList.contains('show-admin-products') && currentUserRole === 'admin') {
                 populateAdminProductLists();
            }
        }
    }

    async function saveProductData() { 
        try {
            const now = new Date();
            productData.meta = {
                version: (productData.meta && typeof productData.meta.version === 'number' ? productData.meta.version : 0) + 1,
                last_updated: now.toISOString()
            };
            const response = await fetch(`https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(productData)
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
            }
            console.log("Dados salvos com sucesso no Pantry!");
            return true;
        } catch (error) {
            console.error("Erro ao salvar dados no Pantry:", error);
            const feedbackEl = document.getElementById('addProductFeedback') || document.getElementById('adminProductManagementFeedback');
            if(feedbackEl) {
                 feedbackEl.textContent = 'Erro ao salvar dados online.';
                 feedbackEl.className = 'error';
            } else {
                console.error("Erro CRÍTICO ao salvar dados online. Verifique seu Pantry ID ou nome da cesta.");
            }
            return false;
        }
    }

    function populateSidebarList(listElement, data) { 
      if(!listElement) return;
      listElement.innerHTML = '';
      if (!data || Object.keys(data).length === 0) {
        const li = document.createElement('li');
        li.textContent = "Nenhum item nesta categoria.";
        li.style.paddingLeft = "8px";
        li.style.fontStyle = "italic";
        listElement.appendChild(li);
        return;
      }
      Object.entries(data).sort(([,a],[,b]) => a.localeCompare(b)).forEach(([code, name]) => {
        const li = document.createElement('li');
        li.classList.add('item');
        li.textContent = `${code.padStart(5, '0')} - ${name}`;
        li.tabIndex = 0;
        li.addEventListener('click', () => {
          showSection('mainTerminalSection');
          if(inputCode) inputCode.value = code.padStart(5, '0');
          displayResult(name, true);
          if(resultDiv) resultDiv.classList.remove('success', 'error');
          if(hamburger) hamburger.classList.remove('open');
          if(sidebar) sidebar.classList.remove('open');
          document.body.classList.remove('sidebar-open');
        });
        listElement.appendChild(li);
      });
    }

    function rebuildProductIndexesAndSidebar() { 
        productsInverseNormalized = {};
        if (productData.bovinos) {
            Object.entries(productData.bovinos).forEach(([code, name]) => {
              productsInverseNormalized[normalizeText(name)] = { code: code.padStart(5, '0'), originalName: name };
            });
        }
        if (productData.suinos) {
            Object.entries(productData.suinos).forEach(([code, name]) => {
              productsInverseNormalized[normalizeText(name)] = { code: code.padStart(5, '0'), originalName: name };
            });
        }
        populateSidebarList(bovinosList, productData.bovinos);
        populateSidebarList(suinosList, productData.suinos);
        prepareAllFlashcardProducts(); 

        if (currentUserRole === 'admin' && mainContent.classList.contains('show-admin-products')) {
            populateAdminProductLists();
        }
    }

    function displayResult(text, isSuccess) { 
      if(!resultDiv) return;
      resultDiv.innerHTML = '';
      resultDiv.classList.remove('scrolling', 'success', 'error');
      const marqueeSpan = document.createElement('span');
      marqueeSpan.textContent = text;
      resultDiv.appendChild(marqueeSpan);
      const icon = document.createElement('i');
      icon.classList.add('feedback-icon', 'fas');
      icon.classList.add(isSuccess ? 'fa-check-circle' : 'fa-times-circle');
      resultDiv.appendChild(icon);
      resultDiv.classList.add(isSuccess ? 'success' : 'error');
      playSound(isSuccess ? 'terminalSuccess' : 'terminalError');
      setTimeout(() => icon.classList.add('show'), 50);
      setTimeout(() => { icon.classList.remove('show'); icon.remove(); }, 1500);
      if (text.length > (resultDiv.offsetWidth / parseFloat(getComputedStyle(resultDiv).fontSize)) * 0.8 ) {
        marqueeSpan.classList.add('marquee');
        void resultDiv.offsetWidth; resultDiv.classList.add('scrolling');
      }
    }

    function buscarCodigoOuNome(inputVal) { 
      const texto = inputVal.trim();
      if (!texto) return { result: "Nenhum valor digitado.", found: false };
      if (/^\d+$/.test(texto)) {
        const codigo = texto.padStart(5, '0');
        const nomeBovino = productData.bovinos ? productData.bovinos[codigo] : undefined;
        const nomeSuino = productData.suinos ? productData.suinos[codigo] : undefined;
        const nomeProduto = nomeBovino || nomeSuino;
        return { result: nomeProduto || `Código "${codigo}" não encontrado.`, found: !!nomeProduto };
      } else {
        const normalizedInput = normalizeText(texto);
        const foundData = productsInverseNormalized[normalizedInput];
        return { result: foundData ? foundData.code : `Produto "${texto}" não encontrado.`, found: !!foundData };
      }
    }

    if(btnExecute && inputCode) { 
      btnExecute.addEventListener('click', () => {
        const valor = inputCode.value;
        const { result: res, found } = buscarCodigoOuNome(valor);
        displayResult(res, found);
      });
      inputCode.addEventListener('keydown', e => { if (e.key === 'Enter') btnExecute.click(); });
      inputCode.addEventListener('input', () => {
        if(resultDiv) { resultDiv.innerHTML = ''; resultDiv.classList.remove('scrolling', 'success', 'error'); }
      });
    }

    function resetAddProductForm() { 
        if(inputNewCode) inputNewCode.value = '';
        if(inputNewName) inputNewName.value = '';
        if(selectNewCategory) selectNewCategory.value = 'bovinos';
        if(inputNewCode) inputNewCode.readOnly = false;
        if(btnAddNewProduct) btnAddNewProduct.textContent = 'Adicionar Produto';
        if(addProductFeedback) {
          addProductFeedback.textContent = '';
          addProductFeedback.className = '';
        }
        if(addProductSectionTitle) addProductSectionTitle.textContent = 'Adicionar Novo Produto';

        const addProductSectionEl = document.getElementById('addProductSection');
        if (addProductSectionEl) {
            delete addProductSectionEl.dataset.editingCode;
            delete addProductSectionEl.dataset.originalCategory;
        }
    }

    function handleSetupEditProduct(event) { 
        if (!currentUser || currentUserRole !== 'admin') {
            showAuthModal('Apenas administradores podem editar produtos.');
            return;
        }
        const { code, name, category } = event.target.dataset;

        showSection('addProductSection', true); 

        if(inputNewCode) {
            inputNewCode.value = code;
            inputNewCode.readOnly = true;
        }
        if(inputNewName) inputNewName.value = name;
        if(selectNewCategory) selectNewCategory.value = category;

        if(btnAddNewProduct) btnAddNewProduct.textContent = 'Salvar Alterações';

        const addProductSectionEl = document.getElementById('addProductSection');
        if (addProductSectionEl) {
            addProductSectionEl.dataset.editingCode = code;
            addProductSectionEl.dataset.originalCategory = category;
        }

        if(addProductFeedback) {
            addProductFeedback.textContent = `Editando produto: ${name} (${code.padStart(5, '0')})`;
            addProductFeedback.className = 'warning';
        }
        if(addProductSectionTitle) addProductSectionTitle.textContent = 'Editar Produto';
    }

    if(btnAddNewProduct && inputNewCode && inputNewName && selectNewCategory && addProductFeedback) { 
      btnAddNewProduct.addEventListener('click', async () => {
          if(addProductFeedback) addProductFeedback.className = '';
          if (!currentUser) {
              addProductFeedback.textContent = 'Você precisa estar logado para esta ação.';
              addProductFeedback.classList.add('error');
              showAuthModal('Você precisa estar logado.');
              return;
          }

          const addProductSectionEl = document.getElementById('addProductSection');
          const editingCode = addProductSectionEl ? addProductSectionEl.dataset.editingCode : null;
          const originalCategory = addProductSectionEl ? addProductSectionEl.dataset.originalCategory : null;

          const newNameVal = inputNewName.value.trim();
          const categoryVal = selectNewCategory.value;

          if (editingCode) { 
              if (currentUserRole !== 'admin') {
                  addProductFeedback.textContent = 'Apenas administradores podem editar produtos.';
                  addProductFeedback.classList.add('error');
                  setTimeout(() => {
                      resetAddProductForm();
                      showSection('initialScreen');
                  }, 3000);
                  return;
              }
              if (!newNameVal) {
                  addProductFeedback.textContent = 'O nome do produto não pode estar vazio.';
                  addProductFeedback.classList.add('warning');
                  return;
              }
              const normalizedNewName = normalizeText(newNameVal);
              for (const cat in productData) {
                  if (cat === 'bovinos' || cat === 'suinos') {
                      for (const codeKey in productData[cat]) {
                          if (codeKey !== editingCode && normalizeText(productData[cat][codeKey]) === normalizedNewName) {
                              addProductFeedback.textContent = `O nome "${newNameVal}" já está em uso por outro produto.`;
                              addProductFeedback.classList.add('error');
                              return;
                          }
                      }
                  }
              }

              if (productData[originalCategory] && productData[originalCategory][editingCode]) {
                  if (originalCategory !== categoryVal) {
                      delete productData[originalCategory][editingCode];
                      if (!productData[categoryVal]) productData[categoryVal] = {};
                      productData[categoryVal][editingCode] = newNameVal;
                  } else {
                      productData[categoryVal][editingCode] = newNameVal;
                  }
              } else {
                  addProductFeedback.textContent = 'Erro: Produto original não encontrado para edição.';
                  addProductFeedback.classList.add('error');
                  setTimeout(() => resetAddProductForm(), 3000);
                  return;
              }

              const successSave = await saveProductData();
              if (successSave) {
                  addProductFeedback.textContent = `Produto "${newNameVal}" (${editingCode.padStart(5, '0')}) atualizado!`;
                  addProductFeedback.classList.add('correct');
                  rebuildProductIndexesAndSidebar();
                  setTimeout(() => {
                      resetAddProductForm();
                      showSection('adminProductManagementSection', true);
                  }, 1500);
              } else {
                  await loadProductData(); 
                  setTimeout(() => resetAddProductForm(), 3000);
              }
          } else { 
              const canAddProducts = currentUserRole === 'admin' || currentUserRole === 'cooperator';
              if (!canAddProducts) {
                  addProductFeedback.textContent = 'Você não tem permissão para adicionar novos produtos.';
                  addProductFeedback.classList.add('error');
                   setTimeout(() => {
                        resetAddProductForm();
                        showSection('initialScreen');
                    }, 2000);
                  return;
              }

              const newCodeVal = inputNewCode.value.trim();
              if (!newCodeVal || !newNameVal || !categoryVal) {
                  addProductFeedback.textContent = 'Preencha todos os campos.'; addProductFeedback.classList.add('warning'); return;
              }
              if (inputNewCode.readOnly) { 
                  inputNewCode.readOnly = false;
              }
              const formattedCode = newCodeVal.padStart(5, '0');
              const codeExists = (productData.bovinos && productData.bovinos[formattedCode]) || (productData.suinos && productData.suinos[formattedCode]);
              if (codeExists) {
                  addProductFeedback.textContent = `Código "${formattedCode}" já existente!`; addProductFeedback.classList.add('error'); return;
              }
              if (productsInverseNormalized[normalizeText(newNameVal)]) {
                  addProductFeedback.textContent = `Nome de produto "${newNameVal}" já existente!`; addProductFeedback.classList.add('error'); return;
              }

              if (categoryVal === 'bovinos') {
                  if (!productData.bovinos) productData.bovinos = {}; productData.bovinos[formattedCode] = newNameVal;
              } else if (categoryVal === 'suinos') {
                  if (!productData.suinos) productData.suinos = {}; productData.suinos[formattedCode] = newNameVal;
              }
              const successSave = await saveProductData();
              if (successSave) {
                  addProductFeedback.textContent = `Produto "${newNameVal}" (${formattedCode}) adicionado!`; addProductFeedback.classList.add('correct');
                  rebuildProductIndexesAndSidebar();
                  setTimeout(() => resetAddProductForm(), 1500);
              } else {
                  if (categoryVal === 'bovinos' && productData.bovinos) delete productData.bovinos[formattedCode];
                  if (categoryVal === 'suinos' && productData.suinos) delete productData.suinos[formattedCode];
                  setTimeout(() => { if(addProductFeedback) addProductFeedback.textContent = ''; addProductFeedback.className = ''; }, 3000);
              }
          }
      });
    }


    async function loadComments() { 
        if (!commentsList || !db) return;
        commentsList.innerHTML = '<p style="text-align: center; color: var(--cor-texto-secundario);">Carregando comentários...</p>';
        try {
            const commentsCollectionRef = collection(db, 'comments');
            const q_comments = query(commentsCollectionRef, orderBy('timestamp', 'desc'), limit(20));
            const querySnapshot = await getDocs(q_comments);
            if (querySnapshot.empty) {
                commentsList.innerHTML = '<p style="text-align: center; color: var(--cor-texto-secundario);">Nenhum comentário ainda. Seja o primeiro a deixar um!</p>'; return;
            }
            commentsList.innerHTML = '';
            querySnapshot.forEach(docSnap => {
                const comment = docSnap.data();
                const commentId = docSnap.id;
                const div = document.createElement('div');
                div.classList.add('comment-item');

                const strongElement = document.createElement('strong');
                const commenterNameText = comment.username || 'Anônimo';

                if (comment.authorRole === 'admin') {
                    const adminSpan = document.createElement('span');
                    adminSpan.classList.add('admin-username');
                    adminSpan.textContent = commenterNameText;
                    strongElement.appendChild(adminSpan);
                } else if (comment.authorRole === 'cooperator') {
                    const cooperatorSpan = document.createElement('span');
                    cooperatorSpan.classList.add('cooperator-username');
                    cooperatorSpan.textContent = commenterNameText;
                    strongElement.appendChild(cooperatorSpan);
                } else {
                    strongElement.textContent = commenterNameText;
                }
                strongElement.appendChild(document.createTextNode(': '));


                const commentTextNode = document.createTextNode(comment.comment + " ");

                const date = comment.timestamp && comment.timestamp.toDate ? new Date(comment.timestamp.toDate()) : new Date();
                const formattedDate = date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const timestampSpan = document.createElement('span');
                timestampSpan.classList.add('timestamp');
                timestampSpan.textContent = formattedDate;

                div.appendChild(strongElement);
                div.appendChild(commentTextNode);
                div.appendChild(timestampSpan);

                if (currentUserRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Apagar';
                    deleteBtn.classList.add('admin-delete-comment-btn'); 
                    deleteBtn.style.cssText = 'background-color: var(--cor-erro); color: white; padding: 3px 8px; font-size: 0.8rem; margin-left: 10px; border: none; border-radius: 3px; cursor: pointer; float: right;';
                    deleteBtn.onmouseover = () => deleteBtn.style.backgroundColor = 'var(--cor-botao-admin-perigo-hover)';
                    deleteBtn.onmouseout = () => deleteBtn.style.backgroundColor = 'var(--cor-erro)';

                    deleteBtn.onclick = async () => {
                        showCustomConfirm('Tem certeza que deseja apagar este comentário? Esta ação é irreversível.', async () => {
                            try {
                                await deleteDoc(doc(db, 'comments', commentId));
                                commentsFeedback.textContent = 'Comentário apagado com sucesso!';
                                commentsFeedback.className = 'correct';
                                loadComments(); 
                            } catch (e) {
                                console.error("Erro ao apagar comentário:", e);
                                commentsFeedback.textContent = `Erro ao apagar: ${e.message}`;
                                commentsFeedback.className = 'error';
                            }
                            setTimeout(() => { if(commentsFeedback) commentsFeedback.textContent = ''; commentsFeedback.className = ''; }, 3000);
                        });
                    };
                    div.appendChild(deleteBtn);
                }
                commentsList.appendChild(div);
            });
        } catch (error) {
            console.error("Erro ao carregar comentários:", error);
            commentsList.innerHTML = `<p style="text-align: center; color: var(--cor-erro);">Erro ao carregar comentários.</p>`;
        }
    }

    if(submitCommentButton && commentInput && commentsFeedback) { 
      submitCommentButton.addEventListener('click', async () => {
          if(commentsFeedback) commentsFeedback.className = '';
          if (!currentUser) {
              commentsFeedback.textContent = 'Você precisa estar logado para enviar um comentário.';
              commentsFeedback.classList.add('error');
              showAuthModal('Você precisa estar logado para enviar um comentário.');
              return;
          }
          const commentText = commentInput.value.trim();
          if (!commentText) {
              commentsFeedback.textContent = 'O comentário não pode estar vazio.'; commentsFeedback.classList.add('warning'); return;
          }
          try {
              const userDocRef = doc(db, 'users', currentUser.uid);
              const userDocSnap = await getDoc(userDocRef);
              const userData = userDocSnap.exists() ? userDocSnap.data() : null;
              const username = userData && userData.username ? userData.username : (currentUser.email ? currentUser.email.split('@')[0] : 'Anônimo');
              const userRoleForComment = userData && userData.role ? userData.role : 'user';

              await addDoc(collection(db, 'comments'), {
                  userId: currentUser.uid,
                  username: username,
                  comment: commentText,
                  timestamp: serverTimestamp(),
                  authorRole: userRoleForComment
              });
              commentsFeedback.textContent = 'Comentário enviado com sucesso!'; commentsFeedback.classList.add('correct');
              commentInput.value = ''; loadComments();
          } catch (error) {
              console.error("Erro ao enviar comentário:", error);
              commentsFeedback.textContent = `Erro ao enviar comentário: ${error.message}`; commentsFeedback.classList.add('error');
          }
          setTimeout(() => { if(commentsFeedback) commentsFeedback.textContent = ''; commentsFeedback.className = ''; }, 3000);
      });
    }

    function populateAdminProductLists() { 
        if (currentUserRole !== 'admin' || !adminBovinosList || !adminSuinosList) return;
        if(adminProductManagementFeedback) adminProductManagementFeedback.className = '';

        adminBovinosList.innerHTML = '';
        adminSuinosList.innerHTML = '';

        const createProductListItem = (code, name, category) => {
            const li = document.createElement('li');
            const infoSpan = document.createElement('span');
            infoSpan.classList.add('product-info');
            infoSpan.textContent = `${code.padStart(5, '0')} - ${name}`;

            const editBtn = document.createElement('button');
            editBtn.textContent = 'Editar';
            editBtn.classList.add('edit-product-btn');
            editBtn.dataset.code = code;
            editBtn.dataset.name = name;
            editBtn.dataset.category = category;
            editBtn.addEventListener('click', handleSetupEditProduct);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Excluir';
            deleteBtn.classList.add('delete-product-btn');
            deleteBtn.dataset.code = code;
            deleteBtn.dataset.category = category;
            deleteBtn.addEventListener('click', handleDeleteProduct);

            li.appendChild(infoSpan);
            li.appendChild(editBtn);
            li.appendChild(deleteBtn);
            return li;
        };

        if (productData.bovinos && Object.keys(productData.bovinos).length > 0) {
            Object.entries(productData.bovinos).sort(([,a],[,b]) => a.localeCompare(b)).forEach(([code, name]) => {
                adminBovinosList.appendChild(createProductListItem(code, name, 'bovinos'));
            });
        } else {
            adminBovinosList.innerHTML = '<li>Nenhum produto bovino cadastrado.</li>';
        }

        if (productData.suinos && Object.keys(productData.suinos).length > 0) {
             Object.entries(productData.suinos).sort(([,a],[,b]) => a.localeCompare(b)).forEach(([code, name]) => {
                adminSuinosList.appendChild(createProductListItem(code, name, 'suinos'));
            });
        } else {
            adminSuinosList.innerHTML = '<li>Nenhum produto suíno cadastrado.</li>';
        }
    }

    async function handleDeleteProduct(event) { 
        if(adminProductManagementFeedback) adminProductManagementFeedback.className = '';
        if (currentUserRole !== 'admin') {
            if(adminProductManagementFeedback) {
                adminProductManagementFeedback.textContent = 'Apenas administradores podem excluir produtos.';
                adminProductManagementFeedback.classList.add('error');
            }
            return;
        }

        const codeToDelete = event.target.dataset.code;
        const categoryToDelete = event.target.dataset.category;

        showCustomConfirm(`Tem certeza que deseja excluir o produto ${codeToDelete}? Esta ação é irreversível!`, async () => {
            let productFoundAndDeleted = false;
            if (categoryToDelete === 'bovinos' && productData.bovinos && productData.bovinos[codeToDelete]) {
                delete productData.bovinos[codeToDelete];
                productFoundAndDeleted = true;
            } else if (categoryToDelete === 'suinos' && productData.suinos && productData.suinos[codeToDelete]) {
                delete productData.suinos[codeToDelete];
                productFoundAndDeleted = true;
            }

            if (productFoundAndDeleted) {
                if(adminProductManagementFeedback) {
                    adminProductManagementFeedback.textContent = 'Tentando excluir produto do Pantry...';
                    adminProductManagementFeedback.className = 'warning';
                }

                const successSave = await saveProductData();
                if (successSave) {
                    if(adminProductManagementFeedback) {
                        adminProductManagementFeedback.textContent = `Produto ${codeToDelete} excluído com sucesso!`;
                        adminProductManagementFeedback.classList.add('correct');
                    }
                    rebuildProductIndexesAndSidebar(); 
                } else {
                    await loadProductData(); 
                }
            } else {
                if(adminProductManagementFeedback) {
                    adminProductManagementFeedback.textContent = 'Produto não encontrado para exclusão.';
                    adminProductManagementFeedback.classList.add('error');
                }
            }
            setTimeout(() => { if(adminProductManagementFeedback) adminProductManagementFeedback.textContent = ''; adminProductManagementFeedback.className = ''; }, 4000);
        });
    }

    // --- Novas Funções para Gerenciamento de Usuários (Admin) ---
    async function populateAdminUserList() {
        if (!adminUserList || !db || currentUserRole !== 'admin' || !currentUser) {
            if(adminUserList) adminUserList.innerHTML = '<li>Acesso negado ou erro ao carregar.</li>';
            return;
        }
        if(adminUserManagementFeedback) adminUserManagementFeedback.textContent = ''; adminUserManagementFeedback.className = '';
        adminUserList.innerHTML = '<li>Carregando usuários...</li>';

        try {
            const usersCollectionRef = collection(db, 'users');
            const querySnapshot = await getDocs(usersCollectionRef);
            
            if (querySnapshot.empty) {
                adminUserList.innerHTML = '<li>Nenhum usuário registrado encontrado.</li>';
                return;
            }

            adminUserList.innerHTML = ''; // Limpa a lista antes de popular
            querySnapshot.forEach(docSnap => {
                const userData = docSnap.data();
                const userId = docSnap.id;

                // Não listar o próprio administrador logado para evitar auto-exclusão acidental
                if (userId === currentUser.uid) {
                    return; 
                }

                const li = document.createElement('li');
                const userInfoSpan = document.createElement('span');
                userInfoSpan.classList.add('user-info');
                userInfoSpan.textContent = `Nome: ${userData.username || 'N/A'} - Email: ${userData.email || 'N/A'} - Papel: ${userData.role || 'user'}`;
                
                const deleteUserBtn = document.createElement('button');
                deleteUserBtn.textContent = 'Excluir Usuário';
                deleteUserBtn.classList.add('delete-user-btn'); // Usar a mesma classe de estilo dos botões de perigo
                deleteUserBtn.dataset.userid = userId;
                deleteUserBtn.dataset.username = userData.username || 'este usuário';

                deleteUserBtn.addEventListener('click', handleDeleteUser);

                li.appendChild(userInfoSpan);
                li.appendChild(deleteUserBtn);
                adminUserList.appendChild(li);
            });

        } catch (error) {
            console.error("Erro ao carregar lista de usuários:", error);
            adminUserList.innerHTML = '<li>Erro ao carregar usuários. Tente novamente.</li>';
            if(adminUserManagementFeedback) {
                adminUserManagementFeedback.textContent = 'Erro ao carregar usuários.';
                adminUserManagementFeedback.className = 'error';
            }
        }
    }

    async function handleDeleteUser(event) {
        if (currentUserRole !== 'admin') {
            if(adminUserManagementFeedback) {
                adminUserManagementFeedback.textContent = 'Apenas administradores podem excluir usuários.';
                adminUserManagementFeedback.className = 'error';
            }
            return;
        }

        const userIdToDelete = event.target.dataset.userid;
        const usernameToDelete = event.target.dataset.username;

        if (!userIdToDelete) {
            console.error("ID do usuário para exclusão não encontrado.");
            if(adminUserManagementFeedback) {
                adminUserManagementFeedback.textContent = 'Erro: ID do usuário não encontrado.';
                adminUserManagementFeedback.className = 'error';
            }
            return;
        }
        
        // Confirmação antes de excluir
        showCustomConfirm(`Tem certeza que deseja excluir o usuário "${usernameToDelete}" (ID: ${userIdToDelete})? Esta ação removerá os dados do usuário da aplicação.`, async () => {
            try {
                await deleteDoc(doc(db, 'users', userIdToDelete));
                
                if(adminUserManagementFeedback) {
                    adminUserManagementFeedback.textContent = `Dados do usuário "${usernameToDelete}" excluídos com sucesso do Firestore.`;
                    adminUserManagementFeedback.className = 'correct';
                }
                // Nota: A conta de autenticação do Firebase (Firebase Auth) NÃO é excluída aqui.
                // Isso precisa ser feito separadamente, geralmente via Admin SDK ou console do Firebase.
                console.warn(`Dados do usuário ${userIdToDelete} excluídos do Firestore. A conta de autenticação do Firebase Auth pode ainda existir.`);
                
                populateAdminUserList(); // Atualiza a lista de usuários
            } catch (error) {
                console.error("Erro ao excluir dados do usuário do Firestore:", error);
                if(adminUserManagementFeedback) {
                    adminUserManagementFeedback.textContent = `Erro ao excluir dados do usuário: ${error.message}`;
                    adminUserManagementFeedback.className = 'error';
                }
            }
            setTimeout(() => { if(adminUserManagementFeedback) adminUserManagementFeedback.textContent = ''; adminUserManagementFeedback.className = ''; }, 4000);
        });
    }


    function showCustomConfirm(message, onConfirm) {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;';
        const modalBox = document.createElement('div');
        modalBox.style.cssText = 'background: var(--cor-fundo-secundario); padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align: center; max-width: 350px; width: 90%;';
        const msgElement = document.createElement('p');
        msgElement.textContent = message;
        msgElement.style.marginBottom = '20px';
        msgElement.style.color = 'var(--cor-texto-principal)';
        msgElement.style.fontSize = '1.05rem';
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'Confirmar';
        confirmBtn.style.cssText = 'background: var(--cor-botao-primario-fundo); color: white; padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;';
        confirmBtn.onmouseover = () => confirmBtn.style.background = 'var(--cor-botao-primario-hover)';
        confirmBtn.onmouseout = () => confirmBtn.style.background = 'var(--cor-botao-primario-fundo)';
        confirmBtn.onclick = () => {
            onConfirm();
            document.body.removeChild(overlay);
        };
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancelar';
        cancelBtn.style.cssText = 'background: var(--cor-botao-secundario-fundo); color: var(--cor-texto-principal); padding: 10px 18px; border: 1px solid var(--cor-botao-secundario-borda); border-radius: 4px; cursor: pointer;';
        cancelBtn.onmouseover = () => cancelBtn.style.background = 'var(--cor-botao-secundario-hover)';
        cancelBtn.onmouseout = () => cancelBtn.style.background = 'var(--cor-botao-secundario-fundo)';
        cancelBtn.onclick = () => {
            document.body.removeChild(overlay);
        };
        modalBox.appendChild(msgElement);
        modalBox.appendChild(confirmBtn);
        modalBox.appendChild(cancelBtn);
        overlay.appendChild(modalBox);
        confirmBtn.focus();
    }

    // --- Event Listeners para Navegação ---
    if(butcherCodeTitle) butcherCodeTitle.addEventListener('click', () => showSection('initialScreen'));
    if(accessTerminalButton) accessTerminalButton.addEventListener('click', () => showSection('mainTerminalSection'));
    if(accessGamesButton) accessGamesButton.addEventListener('click', () => showSection('gamesHubSection'));
    if(viewCommentsButton) viewCommentsButton.addEventListener('click', () => showSection('commentsSection'));
    if(accessInstructionsButton) accessInstructionsButton.addEventListener('click', () => showSection('instructionsSection'));
    if(playGameCodeFromHubButton) playGameCodeFromHubButton.addEventListener('click', () => showSection('gameCodeSection'));
    if(playFlashcardGameButton) playFlashcardGameButton.addEventListener('click', () => showSection('flashcardGameSection'));
    if(backToHomeFromGamesHubButton) backToHomeFromGamesHubButton.addEventListener('click', () => showSection('initialScreen'));
    if(backToGamesHubFromGameCodeButton) backToGamesHubFromGameCodeButton.addEventListener('click', () => showSection('gamesHubSection'));
    if(backToGamesHubFromFlashcardButton) backToGamesHubFromFlashcardButton.addEventListener('click', () => showSection('gamesHubSection'));
    if(backToProfileFromUserAdminButton) backToProfileFromUserAdminButton.addEventListener('click', () => showSection('userProfileSection', true)); // Voltar ao perfil
    
    document.querySelectorAll('.back-to-home-button').forEach(button => {
        button.addEventListener('click', (e) => {
            if (e.target.id === 'backToHomeAddProduct' || mainContent.classList.contains('show-add-product')) {
                 resetAddProductForm();
            }
            showSection('initialScreen');
        });
    });

    document.querySelectorAll('#sidebar h2[data-type="main-content"]').forEach(el => {
        const target = el.dataset.target;
        if (target) {
            el.addEventListener('click', () => {
                if (target === 'userProfileSection' && !currentUser) {
                    showAuthModal('Você precisa fazer login para ver seu perfil.');
                    return;
                }
                showSection(target);
            });
        }
    });

    if(hamburger && sidebar) {
      hamburger.addEventListener('click', () => {
        hamburger.classList.toggle('open'); sidebar.classList.toggle('open'); document.body.classList.toggle('sidebar-open');
      });
    }
    document.addEventListener('click', e => {
      if (sidebar && !sidebar.contains(e.target) && hamburger && !hamburger.contains(e.target) && authModalOverlay && !authModalOverlay.contains(e.target) && e.target !== butcherCodeTitle) {
        if(hamburger) hamburger.classList.remove('open'); if(sidebar) sidebar.classList.remove('open'); document.body.classList.remove('sidebar-open');
      }
    });
    if(sidebarTitles) {
      sidebarTitles.forEach(title => {
        title.addEventListener('click', () => {
          const targetId = title.dataset.target;
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            if (activeAccordionItem && activeAccordionItem !== targetElement) {
                activeAccordionItem.classList.remove('open');
                if(activeAccordionItem.previousElementSibling && activeAccordionItem.previousElementSibling.matches('h2')) {
                    activeAccordionItem.previousElementSibling.classList.remove('open');
                }
            }
            targetElement.classList.toggle('open'); title.classList.toggle('open');
            activeAccordionItem = targetElement.classList.contains('open') ? targetElement : null;
          }
        });
      });
    }

    // --- Lógica dos Jogos (GameCode e Flashcard) ---
    // (Manter a lógica dos jogos como na versão anterior)
    function gameCodeGenerateQuestions() {
        const allProductsList = [];
        if (productData.bovinos) Object.entries(productData.bovinos).forEach(([code, name]) => allProductsList.push([code, name]));
        if (productData.suinos) Object.entries(productData.suinos).forEach(([code, name]) => allProductsList.push([code, name]));
        const generated = []; 
        const numQuestionsToGenerate = Math.min(20, allProductsList.length > 1 ? allProductsList.length * 2 : 20); 
        if (allProductsList.length < 2 && allProductsList.length > 0) { 
             const [correctCode, correctName] = allProductsList[0];
             for (let i = 0; i < numQuestionsToGenerate; i++) {
                const type = Math.random() < 0.5 ? 'codeToName' : 'nameToCode';
                let questionText, correctAnswer;
                let optionsSet = new Set();
                if (type === 'codeToName') {
                    questionText = `Qual o nome do produto com o código: ${correctCode.padStart(5, '0')}?`; correctAnswer = correctName;
                    optionsSet.add(correctName); optionsSet.add("Opção Falsa 1"); optionsSet.add("Opção Falsa 2"); optionsSet.add("Opção Falsa 3");
                } else {
                    questionText = `Qual o código do produto: ${correctName}?`; correctAnswer = correctCode.padStart(5, '0');
                    optionsSet.add(correctCode.padStart(5, '0')); optionsSet.add("0000X"); optionsSet.add("0000Y"); optionsSet.add("0000Z");
                }
                while(optionsSet.size > 4) { optionsSet.delete(Array.from(optionsSet)[Math.floor(Math.random() * optionsSet.size)]);} 
                const shuffledOptions = Array.from(optionsSet); shuffleArray(shuffledOptions);
                generated.push({ question: questionText, options: shuffledOptions, correctAnswer: correctAnswer });
            }
        } else if (allProductsList.length >= 2) {
            for (let i = 0; i < numQuestionsToGenerate; i++) {
                const type = Math.random() < 0.5 ? 'codeToName' : 'nameToCode';
                const [correctCode, correctName] = allProductsList[Math.floor(Math.random() * allProductsList.length)];
                let questionText, correctAnswer; let optionsSet = new Set();
                if (type === 'codeToName') {
                    questionText = `Qual o nome do produto com o código: ${correctCode.padStart(5, '0')}?`; correctAnswer = correctName;
                } else {
                    questionText = `Qual o código do produto: ${correctName}?`; correctAnswer = correctCode.padStart(5, '0');
                }
                optionsSet.add(correctAnswer);
                while (optionsSet.size < Math.min(4, allProductsList.length)) {
                    const [randomCode, randomName] = allProductsList[Math.floor(Math.random() * allProductsList.length)];
                    let randomOption = (type === 'codeToName') ? randomName : randomCode.padStart(5, '0');
                    if (randomOption !== correctAnswer && randomOption !== undefined && randomOption !== null && String(randomOption).trim() !== '') {
                        optionsSet.add(randomOption);
                    }
                }
                const shuffledOptions = Array.from(optionsSet); shuffleArray(shuffledOptions);
                generated.push({ question: questionText, options: shuffledOptions, correctAnswer: correctAnswer });
            }
        } else {
             console.warn("Poucos produtos para gerar perguntas para o GameCode."); return [];
        }
        return generated;
    }
    function gameCodeSaveState() { localStorage.setItem(GAME_CODE_STATE_KEY, JSON.stringify({ gameCodeCurrentQuestionIndex, gameCodeScore, gameCodeQuestions, gameCodeTimeLeft })); }
    function gameCodeLoadState() {
        const savedState = localStorage.getItem(GAME_CODE_STATE_KEY);
        if (savedState) { try {
            const gameState = JSON.parse(savedState);
            if (gameState && typeof gameState.gameCodeCurrentQuestionIndex === 'number' && 
                typeof gameState.gameCodeScore === 'number' && Array.isArray(gameState.gameCodeQuestions) && 
                typeof gameState.gameCodeTimeLeft === 'number') {
                gameCodeCurrentQuestionIndex = gameState.gameCodeCurrentQuestionIndex; 
                gameCodeScore = gameState.gameCodeScore; 
                gameCodeQuestions = gameState.gameCodeQuestions;
                gameCodeTimeLeft = (gameState.gameCodeTimeLeft > 0 && gameState.gameCodeTimeLeft <= TIME_PER_QUESTION) ? gameState.gameCodeTimeLeft : TIME_PER_QUESTION; 
                return true;
            }} catch (e) { console.error("Erro ao carregar estado do GameCode:", e); localStorage.removeItem(GAME_CODE_STATE_KEY); }
        } return false;
    }
    function gameCodeStartTimer() {
        clearInterval(gameCodeTimerInterval); clearInterval(gameCodeTickSoundInterval);
        gameCodeTimeLeft = (gameCodeTimeLeft === undefined || gameCodeTimeLeft === null || gameCodeTimeLeft <= 0 || gameCodeTimeLeft > TIME_PER_QUESTION) ? TIME_PER_QUESTION : gameCodeTimeLeft;
        if(timerElement) { timerElement.textContent = `Tempo: ${gameCodeTimeLeft}s`; timerElement.classList.remove('warning', 'critical'); }
        if(progressBar) progressBar.style.width = `${(gameCodeTimeLeft / TIME_PER_QUESTION) * 100}%`;
        if (gameCodeTimeLeft <= 5 && gameCodeTimeLeft > 0) gameCodeTickSoundInterval = setInterval(() => { if (gameCodeTimeLeft > 0) playSound('tick'); }, 1000);
        
        gameCodeTimerInterval = setInterval(() => {
            gameCodeTimeLeft--; 
            if(timerElement) timerElement.textContent = `Tempo: ${gameCodeTimeLeft}s`;
            const progress = (gameCodeTimeLeft / TIME_PER_QUESTION) * 100; 
            if(progressBar) progressBar.style.width = `${progress}%`;
            
            if (gameCodeTimeLeft <= 5 && gameCodeTimeLeft > 0) {
                if(timerElement) { timerElement.classList.add('warning'); timerElement.classList.remove('critical'); }
                if (!gameCodeTickSoundInterval) gameCodeTickSoundInterval = setInterval(() => { if (gameCodeTimeLeft > 0) playSound('tick'); }, 1000);
            } else if (gameCodeTimeLeft <= 0) {
                clearInterval(gameCodeTimerInterval); clearInterval(gameCodeTickSoundInterval);
                if(timerElement) { timerElement.textContent = "Tempo esgotado!"; timerElement.classList.add('critical'); } 
                gameCodeCheckAnswer(null);
            } else { 
                if(timerElement) timerElement.classList.remove('warning', 'critical'); 
                clearInterval(gameCodeTickSoundInterval); gameCodeTickSoundInterval = null; 
            }
            gameCodeSaveState();
        }, 1000);
    }
    function gameCodeShowQuestion() {
      if (gameCodeCurrentQuestionIndex < gameCodeQuestions.length) {
        gameCodeTimeLeft = TIME_PER_QUESTION; gameCodeStartTimer(); 
        const currentQuestion = gameCodeQuestions[gameCodeCurrentQuestionIndex];
        if(questionElement) questionElement.textContent = currentQuestion.question;
        if(optionsElement) optionsElement.innerHTML = '';
        currentQuestion.options.forEach(option => {
          const button = document.createElement('button'); button.textContent = option; button.dataset.answer = option;
          button.addEventListener('click', gameCodeCheckAnswer); if(optionsElement) optionsElement.appendChild(button);
        });
        if(feedbackElement) { feedbackElement.textContent = ''; feedbackElement.className = ''; }
        if(nextQuestionButton) nextQuestionButton.style.display = 'none';
        if(questionCounterElement) questionCounterElement.textContent = `Pergunta ${gameCodeCurrentQuestionIndex + 1} de ${gameCodeQuestions.length}`;
        
        const totalQuestionsAttempted = gameCodeCurrentQuestionIndex; 
        const percentage = totalQuestionsAttempted > 0 ? (((gameCodeScore / totalQuestionsAttempted) * 100) || 0).toFixed(0) : 0;
        if(scoreDisplayElement) scoreDisplayElement.textContent = `Pontuação: ${gameCodeScore}/${totalQuestionsAttempted} (${percentage}%)`;
        gameCodeSaveState();
      } else gameCodeEndGame(false);
    }
    function gameCodeCheckAnswer(event) {
        clearInterval(gameCodeTimerInterval); clearInterval(gameCodeTickSoundInterval);
        const currentQuestion = gameCodeQuestions[gameCodeCurrentQuestionIndex]; if (!currentQuestion) return;
        const correctAnswer = currentQuestion.correctAnswer; let selectedAnswer = null;
        if (event && event.target) selectedAnswer = event.target.dataset.answer;
        
        if(optionsElement) optionsElement.querySelectorAll('button').forEach(button => {
            button.disabled = true;
            if (button.dataset.answer === correctAnswer) button.style.backgroundColor = 'var(--cor-sucesso)';
            else if (button.dataset.answer === selectedAnswer) button.style.backgroundColor = 'var(--cor-erro)';
        });
        
        if (selectedAnswer === correctAnswer) {
            if(feedbackElement) { feedbackElement.textContent = 'Correto!'; feedbackElement.className = 'correct'; } 
            gameCodeScore++; playSound('correct');
        } else {
            if(feedbackElement) { feedbackElement.textContent = `Incorreto. A resposta correta era: ${currentQuestion.correctAnswer}`; feedbackElement.className = 'incorrect'; } 
            playSound('incorrect');
        }
        gameCodeCurrentQuestionIndex++;
        const totalQuestionsAttempted = gameCodeCurrentQuestionIndex;
        const percentage = totalQuestionsAttempted > 0 ? (((gameCodeScore / totalQuestionsAttempted) * 100) || 0).toFixed(0) : 0;
        if(scoreDisplayElement) scoreDisplayElement.textContent = `Pontuação: ${gameCodeScore}/${totalQuestionsAttempted} (${percentage}%)`;
        
        if(nextQuestionButton) nextQuestionButton.style.display = 'block'; 
        gameCodeSaveState();
    }
    function gameCodeNextQuestion() {
        if(feedbackElement) { feedbackElement.textContent = ''; feedbackElement.className = ''; }
        if(optionsElement) optionsElement.querySelectorAll('button').forEach(button => { button.style.backgroundColor = 'var(--cor-botao-secundario-fundo)'; button.disabled = false; });
        gameCodeShowQuestion();
    }
    function gameCodeEndGame(earlyExit = false) {
        clearInterval(gameCodeTimerInterval); clearInterval(gameCodeTickSoundInterval);
        if(gameElements) gameElements.style.display = 'none'; 
        if(gameEndScreen) gameEndScreen.style.display = 'flex'; 
        playSound('gameEnd');
        
        const totalQuestionsAttempted = gameCodeCurrentQuestionIndex;
        const finalPercentage = totalQuestionsAttempted > 0 ? ((gameCodeScore / totalQuestionsAttempted) * 100).toFixed(0) : 0;
        let message = "Sua pontuação final foi: "; 
        if (earlyExit) message = "Você finalizou o jogo antecipadamente! <br>Sua pontuação parcial foi: ";
        
        if(finalScoreMessage) finalScoreMessage.innerHTML = `${message}<br><span style="font-size: 2em; color: ${finalPercentage >= 70 ? 'var(--cor-sucesso)' : (finalPercentage >= 40 ? 'var(--cor-aviso)' : 'var(--cor-erro)')};">${gameCodeScore} de ${totalQuestionsAttempted} (${finalPercentage}%)</span>`;
        
        if(scoreDisplayElement) scoreDisplayElement.textContent = ''; 
        if(questionCounterElement) questionCounterElement.textContent = '';
        if(timerElement) timerElement.textContent = ''; 
        if(progressBar) progressBar.style.width = '100%';
        localStorage.removeItem(GAME_CODE_STATE_KEY);
    }
    function gameCodeStartGame() {
        if(gameStartScreen) gameStartScreen.style.display = 'none'; 
        if(gameEndScreen) gameEndScreen.style.display = 'none';
        if(gameElements) gameElements.style.display = 'block'; 
        playSound('gameStart');
        
        if (!gameCodeLoadState() || gameCodeQuestions.length === 0 || gameCodeCurrentQuestionIndex >= gameCodeQuestions.length) {
            gameCodeCurrentQuestionIndex = 0; gameCodeScore = 0; 
            gameCodeQuestions = gameCodeGenerateQuestions(); 
            shuffleArray(gameCodeQuestions);
            localStorage.removeItem(GAME_CODE_STATE_KEY); 
            gameCodeTimeLeft = TIME_PER_QUESTION;
        }

        if (gameCodeQuestions.length === 0) {
            if(gameElements) gameElements.style.display = 'none';
            if(gameStartScreen) {
                gameStartScreen.style.display = 'flex'; 
                const h3 = gameStartScreen.querySelector('h3'); if(h3) h3.textContent = 'Atenção!';
                const p = gameStartScreen.querySelector('p'); 
                if(p) p.innerHTML = 'Não há produtos suficientes para gerar perguntas. Adicione mais produtos para começar a jogar!';
            } 
            if(startGameButton) startGameButton.style.display = 'none'; 
            return;
        } else {
             if(startGameButton) startGameButton.style.display = 'block'; 
             if(gameStartScreen){
                 const h3 = gameStartScreen.querySelector('h3'); if(h3) h3.textContent = 'Bem-vindo ao GameCode!';
                 const p = gameStartScreen.querySelector('p'); 
                 if(p) p.innerHTML = 'Teste seus conhecimentos sobre os códigos de açougue.<br>Você terá 15 segundos para responder a cada uma das 20 perguntas.';
             }
        }
        if(scoreDisplayElement) scoreDisplayElement.textContent = '';
        if(nextQuestionButton) {
            nextQuestionButton.textContent = 'Próxima Pergunta'; 
            nextQuestionButton.removeEventListener('click', gameCodeStartGame); 
            nextQuestionButton.addEventListener('click', gameCodeNextQuestion);
        }
        if(optionsElement) optionsElement.querySelectorAll('button').forEach(button => { button.style.backgroundColor = 'var(--cor-botao-secundario-fundo)'; button.disabled = false; });
        gameCodeShowQuestion();
    }

    if(startGameButton) startGameButton.addEventListener('click', gameCodeStartGame);
    if(restartGameButton) restartGameButton.addEventListener('click', gameCodeStartGame);
    if(endGameButton) endGameButton.addEventListener('click', () => gameCodeEndGame(true));


    function loadFlashcardDifficulties() {
        const storedDifficulties = localStorage.getItem(FLASHCARD_DIFFICULTY_KEY);
        if (storedDifficulties) {
            try {
                flashcardDifficulties = JSON.parse(storedDifficulties);
            } catch(e) {
                console.error("Erro ao carregar dificuldades dos flashcards:", e);
                flashcardDifficulties = {};
            }
        } else {
            flashcardDifficulties = {};
        }
    }

    function saveFlashcardDifficulty(code, difficulty) {
        flashcardDifficulties[code] = difficulty;
        localStorage.setItem(FLASHCARD_DIFFICULTY_KEY, JSON.stringify(flashcardDifficulties));
    }

    function prepareAllFlashcardProducts() {
        allFlashcardProducts = [];
        if (productData.bovinos) {
            Object.entries(productData.bovinos).forEach(([code, name]) => allFlashcardProducts.push({ code, name }));
        }
        if (productData.suinos) {
            Object.entries(productData.suinos).forEach(([code, name]) => allFlashcardProducts.push({ code, name }));
        }
    }

    function getNextFlashcard() {
        if (allFlashcardProducts.length === 0) {
            if(flashcardFrontContent) flashcardFrontContent.textContent = "Nenhum produto cadastrado.";
            if(flashcardBackContent) flashcardBackContent.textContent = "";
            if(flipCardButton) flipCardButton.style.display = 'none';
            if(flashcardControlsDiv) flashcardControlsDiv.style.display = 'none';
            if(nextFlashcardButton) nextFlashcardButton.style.display = 'none';
            return null;
        }

        const weightedList = [];
        allFlashcardProducts.forEach(prod => {
            const difficulty = flashcardDifficulties[prod.code] || 'medio'; 
            let weight = 1;
            if (difficulty === 'dificil') weight = 5; 
            else if (difficulty === 'medio') weight = 3;
            
            for (let i = 0; i < weight; i++) {
                weightedList.push(prod);
            }
        });
        
        shuffleArray(weightedList); 

        if (weightedList.length === 0) { 
             currentFlashcard = allFlashcardProducts[Math.floor(Math.random() * allFlashcardProducts.length)];
        } else {
            currentFlashcard = weightedList[Math.floor(Math.random() * weightedList.length)];
        }
        
        currentFlashcard.type = Math.random() < 0.5 ? 'codeToName' : 'nameToCode';
        return currentFlashcard;
    }

    function displayFlashcard() {
        if (!currentFlashcard) {
            currentFlashcard = getNextFlashcard(); 
            if (!currentFlashcard) { 
                 if(flashcardFrontContent) flashcardFrontContent.textContent = "Sem cards disponíveis.";
                 if(flashcardBackContent) flashcardBackContent.textContent = "";
                 if(flipCardButton) flipCardButton.style.display = 'none';
                 if(flashcardControlsDiv) flashcardControlsDiv.style.display = 'none';
                 if(nextFlashcardButton) nextFlashcardButton.style.display = 'none';
                 if(restartFlashcardButton) restartFlashcardButton.style.display = 'none';
                 return;
            }
        }

        flashcardDiv.classList.remove('flipped');
        if(flashcardFeedbackDiv) flashcardFeedbackDiv.textContent = '';
        if(flashcardControlsDiv) flashcardControlsDiv.style.display = 'none';
        if(nextFlashcardButton) nextFlashcardButton.style.display = 'none';
        if(flipCardButton) flipCardButton.style.display = 'block';
        if(restartFlashcardButton) restartFlashcardButton.style.display = 'block';
        
        difficultyButtons.forEach(btn => btn.classList.remove('selected'));

        if (currentFlashcard.type === 'codeToName') {
            if(flashcardFrontLabel) flashcardFrontLabel.textContent = "Código do Produto:";
            if(flashcardFrontContent) flashcardFrontContent.textContent = currentFlashcard.code.padStart(5, '0');
            if(flashcardBackLabel) flashcardBackLabel.textContent = "Nome do Produto:";
            if(flashcardBackContent) flashcardBackContent.textContent = currentFlashcard.name;
        } else { 
            if(flashcardFrontLabel) flashcardFrontLabel.textContent = "Nome do Produto:";
            if(flashcardFrontContent) flashcardFrontContent.textContent = currentFlashcard.name;
            if(flashcardBackLabel) flashcardBackLabel.textContent = "Código do Produto:";
            if(flashcardBackContent) flashcardBackContent.textContent = currentFlashcard.code.padStart(5, '0');
        }
    }

    function startFlashcardGame() {
        loadFlashcardDifficulties();
        prepareAllFlashcardProducts(); 
        if (allFlashcardProducts.length === 0) {
            if(flashcardFrontContent) flashcardFrontContent.textContent = "Adicione produtos para usar os flashcards.";
            if(flashcardBackContent) flashcardBackContent.textContent = "";
            if(flipCardButton) flipCardButton.style.display = 'none';
            if(flashcardControlsDiv) flashcardControlsDiv.style.display = 'none';
            if(nextFlashcardButton) nextFlashcardButton.style.display = 'none';
            if(restartFlashcardButton) restartFlashcardButton.style.display = 'none';
            if(flashcardFeedbackDiv) {
                 flashcardFeedbackDiv.textContent = 'Não há produtos para exibir nos flashcards.';
                 flashcardFeedbackDiv.className = 'info';
            }
            return;
        } else {
            if(restartFlashcardButton) restartFlashcardButton.style.display = 'block';
        }
        
        currentFlashcard = null; 
        displayFlashcard(); 
    }

    if(flipCardButton) {
        flipCardButton.addEventListener('click', () => {
            if (!currentFlashcard) return; 
            flashcardDiv.classList.toggle('flipped');
            playSound('flip');
            if(flashcardControlsDiv) flashcardControlsDiv.style.display = 'block';
            if(nextFlashcardButton) nextFlashcardButton.style.display = 'block';
            if(flipCardButton) flipCardButton.style.display = 'none';

            const currentDifficulty = flashcardDifficulties[currentFlashcard.code];
            difficultyButtons.forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.difficulty === currentDifficulty) {
                    btn.classList.add('selected');
                }
            });
        });
    }

    difficultyButtons.forEach(button => {
        button.addEventListener('click', () => {
            if (!currentFlashcard) return;
            const difficulty = button.dataset.difficulty;
            saveFlashcardDifficulty(currentFlashcard.code, difficulty);
            
            difficultyButtons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');

            if(flashcardFeedbackDiv) {
                flashcardFeedbackDiv.textContent = `Card classificado como "${difficulty}".`;
                flashcardFeedbackDiv.className = 'info';
                 setTimeout(() => { if(flashcardFeedbackDiv) flashcardFeedbackDiv.textContent = ''; flashcardFeedbackDiv.className = ''; }, 2000);
            }
        });
    });

    if(nextFlashcardButton) {
        nextFlashcardButton.addEventListener('click', () => {
            currentFlashcard = null; 
            displayFlashcard();
        });
    }
    
    if(restartFlashcardButton) {
        restartFlashcardButton.addEventListener('click', () => {
            showCustomConfirm("Tem certeza que deseja reiniciar o progresso de todos os flashcards? As classificações de dificuldade serão perdidas.", () => {
                flashcardDifficulties = {};
                localStorage.removeItem(FLASHCARD_DIFFICULTY_KEY);
                if(flashcardFeedbackDiv) {
                    flashcardFeedbackDiv.textContent = "Progresso dos flashcards reiniciado.";
                    flashcardFeedbackDiv.className = 'info';
                }
                setTimeout(() => { if(flashcardFeedbackDiv) flashcardFeedbackDiv.textContent = ''; flashcardFeedbackDiv.className = ''; }, 2000);
                startFlashcardGame(); 
            });
        });
    }

    loadProductData(); 
    showSection('initialScreen'); 
  });
</script>
</body>
</html>
